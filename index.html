<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study-Start Pro</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23007aff'/></svg>" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --off-white: #fafafa; 
            --bg-color: #f0f2f5; 
            --sidebar-bg: var(--off-white);
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-muted: #666666;
            --primary-color: #007aff; 
            --primary-hover: #005bb5;
            --border-color: #e4e6eb;
            --table-header-bg: #f8f9fa;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --danger-color: #ff3b30;
            --holiday-bg: #fff9e6; 
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; transition: all 0.3s; }

        /* SIDEBAR */
        #app-sidebar { width: 260px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 25px; flex-shrink: 0; transition: margin-left 0.3s; }
        .sidebar-logo { font-size: 1.4em; font-weight: 800; color: var(--primary-color); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: var(--text-muted); font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background-color: rgba(0, 122, 255, 0.1); color: var(--primary-color); }

        /* CONTENT */
        #main-content { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; position: relative; }
        header { background-color: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; transition: top 0.3s; }
        
        /* LAYOUTS */
        .page-section { display: none; padding: 30px; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .page-section.active { display: flex; gap: 30px; flex-direction: column; }
        #page-planning.active { flex-direction: row; }
        #planner-column { flex: 1; min-width: 0; } 
        #tools-column { width: 350px; flex-shrink: 0; }

        /* DASHBOARD GRID */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; width: 100%; }
        .stat-big-number { font-size: 3em; font-weight: 800; color: var(--primary-color); line-height: 1; }
        .xp-bar-container { background: #eee; height: 10px; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary-color), #00c6ff); width: 0%; transition: width 0.5s ease; }

        /* CARDS & UI */
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        h2 { margin-top: 0; margin-bottom: 20px; font-size: 1.6em; letter-spacing: -0.5px; }
        h3 { margin-top: 0; font-size: 1.1em; margin-bottom: 15px; font-weight: 600; }
        
        input, select, textarea { width: 100%; background-color: #fff; border: 1px solid #ddd; color: var(--text-color); padding: 12px; border-radius: 8px; font-family: inherit; box-sizing: border-box; margin-bottom: 10px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1); }

        button { width: 100%; background-color: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.95em; }
        button:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        button.secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); }
        button.secondary:hover { background-color: #f5f5f5; color: var(--text-color); transform: none; }

        /* ZEN MODE */
        body.zen-mode #app-sidebar { margin-left: -260px; }
        body.zen-mode header { top: -100px; }
        body.zen-mode #main-content { background-color: #111; color: #eee; } /* Dark mode voor focus */
        body.zen-mode .card { background-color: #222; border-color: #333; color: #eee; box-shadow: none; }
        body.zen-mode #zen-exit-btn { display: block !important; }

        #zen-exit-btn {
            position: fixed; top: 20px; right: 20px; z-index: 2000;
            background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);
            width: auto; backdrop-filter: blur(5px); display: none;
        }
        #zen-exit-btn:hover { background: rgba(255,255,255,0.2); }

        /* LOGIN */
        #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: flex; justify-content: center; align-items: center; background-color: var(--bg-color); }
        .login-card { background: white; padding: 50px; border-radius: 24px; text-align: center; width: 100%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }

        /* TABLE */
        .table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 12px; background: white; }
        .studie-tabel { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 800px; }
        .studie-tabel th { background-color: var(--table-header-bg); color: var(--text-muted); text-transform: uppercase; font-size: 0.75em; padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .studie-tabel td { padding: 15px; border-bottom: 1px solid var(--border-color); vertical-align: top; }
        .studie-tabel tr:last-child td { border-bottom: none; }
        
        .col-week { width: 12%; font-weight: 700; color: var(--primary-color); }
        .col-vak { width: 12%; font-weight: 600; }
        .col-thuis { width: 40%; } 
        .col-bijles { width: 25%; }
        .col-status { width: 50px; text-align: center; padding-left: 0; padding-right: 0; }

        .editable-area { width: 100%; min-height: 40px; border: 1px solid transparent; padding: 8px; border-radius: 6px; resize: none; overflow: hidden; font-family: inherit; transition: 0.2s; }
        .editable-area:hover { background-color: #f9f9f9; }
        .editable-area:focus { border-color: var(--primary-color); background: white; box-shadow: 0 0 0 2px rgba(0,122,255,0.1); }

        /* Checkbox */
        .status-container { display: flex; justify-content: center; align-items: center; height: 100%; }
        .status-container input { width: 24px; height: 24px; margin: 0; cursor: pointer; accent-color: var(--success-color); }
        
        /* Calc & Grades */
        .calc-result { margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 8px; color: var(--primary-color); font-weight: bold; text-align: center; display: none; }

        @media (max-width: 1100px) {
            body { flex-direction: column; height: auto; overflow-y: auto;}
            #app-sidebar { width: 100%; flex-direction: row; overflow-x: auto; height: auto; }
            .page-section.active { flex-direction: column; }
            #tools-column { width: 100%; order: -1; }
        }
    </style>
</head>
<body>

    <!-- ZEN MODE EXIT BUTTON -->
    <button id="zen-exit-btn" onclick="toggleZenMode()">‚úï Sluit Focus Mode</button>

    <!-- LOGIN -->
    <div id="login-page" style="display: none;">
        <div class="login-card">
            <h1 style="color: var(--primary-color);">Study-Start</h1>
            <p>Log in om je planner te openen.</p>
            <button onclick="signInWithGoogle()" style="background: white; color: #333; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Inloggen met Google
            </button>
        </div>
    </div>

    <!-- APP -->
    <nav id="app-sidebar" style="display: none;">
        <div class="sidebar-logo">Study-Start</div>
        <div class="nav-item active" onclick="navigate('dashboard')">üè† Dashboard</div>
        <div class="nav-item" onclick="navigate('planning')">üìÖ Planning</div>
        <div class="nav-item" onclick="navigate('cijfers')">üìä Cijfers</div>
        <div class="nav-item" onclick="navigate('timer')">‚è±Ô∏è Focus Timer</div>
        <div class="nav-item" onclick="navigate('notities')">üìù Notities</div>
        <div class="nav-item" onclick="navigate('instellingen')">‚öôÔ∏è Instellingen</div>
    </nav>

    <main id="main-content" style="display: none;">
        <header>
            <div id="shared-badge" style="display: none; background: #fff3cd; color: #856404; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; margin-right: 15px; border: 1px solid #ffeeba;">
                üëÅÔ∏è Je kijkt mee
            </div>
            <span id="user-display-name" style="font-weight: 600; margin-right: 15px;">Gast</span>
            <button onclick="signOutUser()" class="secondary" style="width: auto; padding: 8px 15px;">Uitloggen</button>
        </header>

        <!-- PAGINA 0: DASHBOARD (NIEUW) -->
        <div id="page-dashboard" class="page-section active">
            <h2>üëã Welkom terug!</h2>
            <div class="dashboard-grid">
                <!-- Widget 1: Profiel & XP -->
                <div class="card">
                    <h3>Jouw Profiel</h3>
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div>
                            <div class="stat-big-number" id="dash-level">1</div>
                            <div style="color: var(--text-muted);">Huidig Level</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="stat-big-number" style="color: var(--warning-color);" id="dash-streak">0</div>
                            <div style="color: var(--text-muted);">Dagen Streak üî•</div>
                        </div>
                    </div>
                    <div class="xp-bar-container">
                        <div id="xp-fill" class="xp-bar-fill"></div>
                    </div>
                    <p style="font-size: 0.8em; text-align: right; margin-top: 5px; color: var(--text-muted);"><span id="dash-xp">0</span> / 100 XP</p>
                </div>

                <!-- Widget 2: Volgende Deadline -->
                <div class="card">
                    <h3>üìÖ Eerstvolgende Toets</h3>
                    <div id="dash-next-exam">
                        <p style="color: var(--text-muted);">Geen toetsen gepland.</p>
                    </div>
                    <button onclick="navigate('planning')" class="secondary" style="margin-top: 15px;">Ga naar Planning</button>
                </div>

                <!-- Widget 3: Quick Actions -->
                <div class="card">
                    <h3>üöÄ Snelstart</h3>
                    <button onclick="navigate('timer')" style="margin-bottom: 10px;">Start Focus Sessie</button>
                    <button onclick="navigate('notities')" class="secondary">Nieuwe Notitie</button>
                </div>
            </div>
        </div>

        <!-- PAGINA 1: PLANNING -->
        <div id="page-planning" class="page-section">
            <div id="planner-column">
                <h2>Jouw Planning</h2>
                <div id="loading-indicator" style="color: var(--text-muted);">Laden...</div>
                <div class="table-container">
                    <table class="studie-tabel">
                        <thead>
                            <tr>
                                <th class="col-week">Week</th>
                                <th class="col-vak">Vak</th>
                                <th class="col-thuis">Thuis Doen</th>
                                <th class="col-bijles">Bijles</th>
                                <th class="col-status"></th>
                            </tr>
                        </thead>
                        <tbody id="planner-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="tools-column">
                <!-- SHARE -->
                <div class="card" id="share-card" style="border: 1px solid var(--primary-color);">
                    <h3 style="color: var(--primary-color);">ü§ù Samenwerken</h3>
                    <p style="font-size: 0.9em; color: var(--text-muted);">Voeg e-mail van docent toe:</p>
                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                        <input type="email" id="collabEmail" placeholder="docent@email.com" style="margin-bottom:0;">
                        <div style="display: flex; gap: 5px;">
                            <select id="collabRole" style="margin-bottom:0; flex: 1;">
                                <option value="read">Lezen</option>
                                <option value="edit">Bewerken</option>
                            </select>
                            <button onclick="addCollaborator()" style="width: auto;">+</button>
                        </div>
                    </div>
                    <div id="collaborators-list"></div>
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                    <p style="font-size: 0.85em; color: var(--text-muted);">Deel-Link:</p>
                    <input type="text" id="shareLinkInput" readonly style="font-size: 0.8em; color: var(--primary-color); cursor: copy; background: #f0f8ff; border-color: #b3d7ff;" onclick="this.select(); document.execCommand('copy'); alert('Link gekopieerd!');">
                </div>

                <!-- AUTO PLANNER -->
                <div class="card" id="auto-planner-card">
                    <h3>‚ö° Nieuwe Toets</h3>
                    <input type="text" list="vakken-list" id="autoVakInput" placeholder="Vak">
                    <datalist id="vakken-list">
                        <option value="Wiskunde A"><option value="Wiskunde B"><option value="Natuurkunde">
                        <option value="Scheikunde"><option value="Biologie"><option value="Economie">
                        <option value="Geschiedenis"><option value="Aardrijkskunde"><option value="Nederlands">
                        <option value="Engels">
                    </datalist>
                    <select id="autoHoofdstukInput">
                        <option value="" disabled selected>Hoofdstuk</option>
                        <option value="H1">H1</option><option value="H2">H2</option><option value="H3">H3</option>
                        <option value="H4">H4</option><option value="H5">H5</option><option value="H6">H6</option>
                    </select>
                    <input type="date" id="autoDatumInput">
                    <button onclick="generateAutoPlanning()">Inplannen</button>
                </div>
            </div>
        </div>

        <!-- PAGINA 2: CIJFERS & CALCULATOR -->
        <div id="page-cijfers" class="page-section">
            <h2>Mijn Cijfers</h2>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <div class="card">
                        <h3>Cijfer Toevoegen</h3>
                        <input type="text" id="gradeSubject" placeholder="Vak">
                        <input type="number" id="gradeValue" placeholder="Cijfer" step="0.1">
                        <input type="number" id="gradeWeight" placeholder="Weging" value="1">
                        <button onclick="addGrade()">Opslaan</button>
                    </div>
                    <!-- TARGET CALCULATOR -->
                    <div class="card" style="border-top: 4px solid var(--primary-color);">
                        <h3>üéØ Doel Calculator</h3>
                        <p style="font-size:0.9em; color:var(--text-muted);">Wat moet ik halen?</p>
                        <input type="number" id="calcCurrentAvg" placeholder="Huidig Gemiddelde" step="0.1">
                        <input type="number" id="calcCurrentWeight" placeholder="Totaal gewicht tot nu" step="1">
                        <input type="number" id="calcNewWeight" placeholder="Gewicht nieuwe toets" value="1">
                        <input type="number" id="calcTarget" placeholder="Gewenst Eindcijfer" step="0.1">
                        <button class="secondary" onclick="calculateGradeTarget()">Bereken</button>
                        <div id="calcResult" class="calc-result"></div>
                    </div>
                </div>
                <div class="card" style="flex: 2; min-width: 300px;">
                    <h3>Overzicht</h3>
                    <div id="grades-list">Laden...</div>
                </div>
            </div>
        </div>

        <!-- PAGINA 3: TIMER & ZEN MODE -->
        <div id="page-timer" class="page-section" style="align-items: center; text-align: center;">
            <h2>Focus Timer</h2>
            <div class="card" style="max-width: 400px; width: 100%;">
                <input type="number" id="timerInput" value="25" min="1" style="text-align: center; font-size: 1.2em; width: 80px; margin: 0 auto 10px;">
                <div id="timer-display" style="font-size: 4em; font-weight: 700; color: var(--primary-color); margin: 20px 0;">25:00</div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="startTimer()">Start</button>
                    <button onclick="stopTimer()" class="secondary">Stop</button>
                    <button onclick="resetTimer()" class="secondary">Reset</button>
                </div>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                <button onclick="toggleZenMode()" style="background: #222; color: #fff;">üßò Start Zen Mode</button>
            </div>
        </div>

        <!-- PAGINA 4: NOTITIES -->
        <div id="page-notities" class="page-section">
            <h2>Notities</h2>
            <div style="display: flex; gap: 20px;">
                 <div class="card" style="width: 300px;">
                     <h3>Nieuwe Notitie</h3>
                     <input type="text" id="noteSubject" placeholder="Vak">
                     <input type="date" id="noteDate">
                     <textarea id="noteContent" style="height: 100px;" placeholder="Inhoud..."></textarea>
                     <button onclick="addNote()">Opslaan</button>
                 </div>
                 <div class="card" style="flex: 1;">
                     <h3>Mijn Notities</h3>
                     <div id="notes-list-container">Laden...</div>
                 </div>
            </div>
        </div>

        <!-- PAGINA 5: INSTELLINGEN -->
        <div id="page-instellingen" class="page-section">
            <h2>Instellingen</h2>
            <div class="card">
                <h3>Account</h3>
                <input type="text" id="settings-name" placeholder="Jouw naam">
                <button onclick="saveSettings()" style="width: auto;">Opslaan</button>
            </div>
        </div>
    </main>

    <script>
        /* CONFIG */
        const firebaseConfig = {
          apiKey: "AIzaSyD_Kg4HjgBpG9QqpEuxfBklPL5-34G3RHI",
          authDomain: "study-start-c510c.firebaseapp.com",
          projectId: "study-start-c510c",
          storageBucket: "study-start-c510c.firebasestorage.app",
          messagingSenderId: "960911379164",
          appId: "1:960911379164:web:ad8648cfa2fe65f8620219"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUserId = null;
        let viewUserId = null;
        let userRole = 'owner'; 

        let timerInterval = null;
        let timeLeft = 25 * 60;

        /* AUTH & INIT */
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('user-display-name').innerText = user.email;
                
                const params = new URLSearchParams(window.location.search);
                const targetUid = params.get('uid');

                if (targetUid && targetUid !== currentUserId) {
                    viewUserId = targetUid;
                    checkAccess(targetUid, user.email);
                } else {
                    viewUserId = currentUserId;
                    userRole = 'owner';
                    initApp();
                }

                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-sidebar').style.display = 'flex';
                document.getElementById('main-content').style.display = 'flex';
                document.getElementById('shareLinkInput').value = `${window.location.origin}${window.location.pathname}?uid=${currentUserId}`;

            } else {
                document.getElementById('login-page').style.display = 'flex';
            }
        });

        function checkAccess(targetUid, email) {
            db.collection('users').doc(targetUid).collection('collaborators').doc(email.toLowerCase()).get()
            .then(doc => {
                if (doc.exists) {
                    userRole = doc.data().role || 'read'; 
                    initApp();
                } else {
                    alert("Geen toegang tot dit schema.");
                    window.location.href = window.location.pathname;
                }
            }).catch(() => {
                alert("Fout bij controleren toegang.");
                window.location.href = window.location.pathname;
            });
        }

        function initApp() {
            updateInterfaceForRole();
            initPlanner();
            if(userRole === 'owner' || userRole === 'edit') {
                loadUserProfile(); // Laad XP/Streak
                loadNotes();
                loadGrades();
            }
        }

        function updateInterfaceForRole() {
            if (userRole === 'read') {
                document.getElementById('read-only-badge').style.display = 'inline-block';
                document.getElementById('share-card').style.display = 'none';
                document.getElementById('auto-planner-card').style.display = 'none'; 
            } else if (userRole === 'edit') {
                document.getElementById('shared-badge').style.display = 'inline-block';
                document.getElementById('share-card').style.display = 'none';
            } else {
                document.getElementById('share-card').style.display = 'block';
                loadCollaborators();
            }
        }

        function signInWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => alert(e.message)); }
        function signOutUser() { auth.signOut().then(() => window.location.href = window.location.pathname); }
        
        function navigate(id) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${id}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        /* --- GAMIFICATION & DASHBOARD --- */
        function loadUserProfile() {
            const todayStr = new Date().toDateString();
            const userRef = db.collection('users').doc(viewUserId);
            
            userRef.onSnapshot(doc => {
                const data = doc.data() || { xp: 0, streak: 0, lastLogin: '' };
                
                // Streak Logic (simpel)
                if (data.lastLogin !== todayStr) {
                    // Update login date, eventueel streak logica hier uitbreiden
                    if (userRole === 'owner') userRef.set({ lastLogin: todayStr }, { merge: true });
                }

                const level = Math.floor(data.xp / 100) + 1;
                const xpProgress = data.xp % 100;

                document.getElementById('dash-level').innerText = level;
                document.getElementById('dash-streak').innerText = data.streak || 0;
                document.getElementById('dash-xp').innerText = data.xp || 0;
                document.getElementById('xp-fill').style.width = `${xpProgress}%`;
            });
        }

        function addXP(amount) {
            if (userRole !== 'owner') return;
            db.collection('users').doc(currentUserId).update({
                xp: firebase.firestore.FieldValue.increment(amount)
            });
        }

        /* --- CALC --- */
        function calculateGradeTarget() {
            const curAvg = parseFloat(document.getElementById('calcCurrentAvg').value);
            const curWeight = parseFloat(document.getElementById('calcCurrentWeight').value);
            const newWeight = parseFloat(document.getElementById('calcNewWeight').value);
            const target = parseFloat(document.getElementById('calcTarget').value);
            
            if(isNaN(curAvg) || isNaN(curWeight) || isNaN(newWeight) || isNaN(target)) return;
            
            // Formule: (Doel * (TotaalGewicht + NieuwGewicht) - (Huidig * TotaalGewicht)) / NieuwGewicht
            const required = ((target * (curWeight + newWeight)) - (curAvg * curWeight)) / newWeight;
            
            const resDiv = document.getElementById('calcResult');
            resDiv.style.display = 'block';
            resDiv.innerHTML = `Je moet een <span style="font-size:1.2em;">${required.toFixed(1)}</span> halen!`;
        }

        /* --- ZEN MODE --- */
        function toggleZenMode() {
            document.body.classList.toggle('zen-mode');
        }

        /* --- PLANNER LOGIC --- */
        function addCollaborator() {
            const email = document.getElementById('collabEmail').value.toLowerCase().trim();
            const role = document.getElementById('collabRole').value;
            if(!email) return;
            
            db.collection('users').doc(currentUserId).collection('collaborators').doc(email).set({
                role: role, addedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => { alert('Toegang gegeven!'); document.getElementById('collabEmail').value = ''; });
        }

        function loadCollaborators() {
            db.collection('users').doc(currentUserId).collection('collaborators').onSnapshot(snap => {
                const list = document.getElementById('collaborators-list');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const div = document.createElement('div');
                    div.className = 'collab-item';
                    div.innerHTML = `<span>${doc.id} (${d.role})</span> <button onclick="removeCollab('${doc.id}')" class="secondary" style="width:auto; padding:2px 8px; font-size:0.7em;">X</button>`;
                    list.appendChild(div);
                });
            });
        }
        function removeCollab(e) { if(confirm('Intrekken?')) db.collection('users').doc(currentUserId).collection('collaborators').doc(e).delete(); }

        function generateAutoPlanning() {
            if (userRole === 'read') return alert("Alleen lezen.");
            const vak = document.getElementById('autoVakInput').value;
            const hst = document.getElementById('autoHoofdstukInput').value;
            const dateVal = document.getElementById('autoDatumInput').value;
            if(!vak || !hst || !dateVal) return alert("Vul alles in.");
            
            const toetsDate = new Date(dateVal);
            let curr = new Date(); curr.setDate(curr.getDate() - curr.getDay() + 1);
            const batch = db.batch();
            
            while(curr <= toetsDate) {
                 const end = new Date(curr); end.setDate(curr.getDate()+6);
                 const id = `${vak}-${curr.getTime()}`;
                 batch.set(db.collection('users').doc(viewUserId).collection('planner_items').doc(id), {
                     weekStart: firebase.firestore.Timestamp.fromDate(curr),
                     weekEnd: firebase.firestore.Timestamp.fromDate(end),
                     weekNummer: getWeekNumber(curr),
                     vak: vak,
                     thuisDoen: `Oefenen ${vak} ${hst}`,
                     bijlesDoen: `Vragen ${hst}`,
                     isAfgerond: false, isVakantie: false, isBijlesNodig: true,
                     groupKey: `${curr.getFullYear()}-${getWeekNumber(curr)}`
                 });
                 curr.setDate(curr.getDate()+7);
            }
            batch.commit().then(() => alert("Gepland!"));
        }

        function initPlanner() {
            db.collection('users').doc(viewUserId).collection('planner_items')
                .orderBy('weekStart', 'asc')
                .onSnapshot(snapshot => {
                    document.getElementById('loading-indicator').style.display = 'none';
                    const tbody = document.getElementById('planner-table-body');
                    tbody.innerHTML = '';
                    
                    const nextExamEl = document.getElementById('dash-next-exam');
                    let firstExamFound = false;

                    const grouped = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        data.id = doc.id;
                        data.jsDate = data.weekStart.toDate();
                        const key = data.groupKey || `${data.jsDate.getFullYear()}-${data.weekNummer}`;
                        if(!grouped[key]) grouped[key] = [];
                        grouped[key].push(data);
                        
                        // Dashboard Logic: Find next exam (simple check: contains 'TOETS')
                        if (!firstExamFound && data.thuisDoen.includes('TOETS')) {
                            if (nextExamEl) nextExamEl.innerHTML = `<h3 style="color:var(--primary-color); margin:0;">${data.vak}</h3><p>${data.thuisDoen}</p>`;
                            firstExamFound = true;
                        }
                    });

                    const keys = Object.keys(grouped).sort((a,b) => grouped[a][0].jsDate - grouped[b][0].jsDate);
                    if(keys.length === 0) tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#999;'>Nog geen planning.</td></tr>";
                    keys.forEach(key => renderGroupedRow(tbody, grouped[key], userRole !== 'read'));
                }, err => {
                    if(err.code === 'permission-denied') alert("Geen toegang.");
                });
        }

        function renderGroupedRow(container, items, isEditable) {
            const firstItem = items[0];
            const weekEndStr = firstItem.weekEnd.toDate().toLocaleDateString('nl-NL', {day: 'numeric', month: 'short'});
            const isHoliday = items.some(i => i.isVakantie);
            const row = document.createElement('tr');
            if (isHoliday) row.classList.add('is-holiday');

            let vakHtml = '', thuisHtml = '', bijlesHtml = '', statusHtml = '';

            items.forEach((item, index) => {
                const border = index < items.length - 1 ? 'border-bottom: 1px dashed var(--border-color); padding-bottom: 10px; margin-bottom: 10px;' : '';
                vakHtml += `<div style="${border} font-weight:600; padding-top:5px;">${item.vak}</div>`;
                thuisHtml += `<div style="${border}"><textarea class="editable-area" onblur="updateField('${item.id}', 'thuisDoen', this.value)" ${!isEditable || isHoliday ? 'disabled' : ''}>${isHoliday ? 'VAKANTIE!' : item.thuisDoen}</textarea></div>`;
                
                const bijlesClass = item.isBijlesNodig === false ? 'opacity:0.5; text-decoration:line-through;' : '';
                bijlesHtml += `<div style="${border}; display:flex; gap:5px; ${bijlesClass}">
                    <label class="switch" style="transform:scale(0.6);"><input type="checkbox" ${item.isBijlesNodig!==false?'checked':''} onchange="updateField('${item.id}', 'isBijlesNodig', this.checked)" ${!isEditable ? 'disabled' : ''}><span class="slider"></span></label>
                    <textarea class="editable-area" onblur="updateField('${item.id}', 'bijlesDoen', this.value)" ${!isEditable || isHoliday ? 'disabled' : ''}>${isHoliday ? '-' : item.bijlesDoen}</textarea>
                </div>`;

                statusHtml += `<div style="${border}; display:flex; justify-content:center; height:40px; align-items:center;">
                    <div class="status-container"><input type="checkbox" ${item.isAfgerond ? 'checked' : ''} onchange="updateField('${item.id}', 'isAfgerond', this.checked)" ${!isEditable ? 'disabled' : ''}></div>
                    ${isEditable ? `<button onclick="deleteItem('${item.id}')" style="margin-left:5px; background:transparent; color:#ccc; padding:0; width:auto;">&times;</button>` : ''}
                </div>`;
            });

            row.innerHTML = `
                <td class="col-week" style="border-right: 1px solid var(--border-color);">
                    WEEK ${firstItem.weekNummer}<br>
                    <span style="font-size:0.8em; color:var(--text-muted)">t/m zo ${weekEndStr}</span>
                    <div style="margin-top:5px;"><label style="font-size:0.7em;"><input type="checkbox" ${isHoliday?'checked':''} onchange="toggleHoliday('${items.map(i=>i.id).join(',')}', this.checked)" ${!isEditable ? 'disabled' : ''}> Vakantie</label></div>
                </td>
                <td class="col-vak">${vakHtml}</td>
                <td class="col-thuis">${thuisHtml}</td>
                <td class="col-bijles">${bijlesHtml}</td>
                <td class="col-status">${statusHtml}</td>
            `;
            container.appendChild(row);
        }

        function updateField(id, f, v) { 
            if(userRole !== 'read') {
                db.collection('users').doc(viewUserId).collection('planner_items').doc(id).update({[f]: v}); 
                if (f === 'isAfgerond' && v === true) addXP(10); // Gamification trigger
            }
        }
        function toggleHoliday(ids, val) { if(userRole !== 'read') { const b=db.batch(); ids.split(',').forEach(id=>b.update(db.collection('users').doc(viewUserId).collection('planner_items').doc(id),{isVakantie:val})); b.commit(); } }
        function deleteItem(docId) { if (userRole !== 'read' && confirm("Item verwijderen?")) db.collection('users').doc(viewUserId).collection('planner_items').doc(docId).delete(); }
        function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); }

        /* --- GRADES LOGIC --- */
        function addGrade() {
            const s = document.getElementById('gradeSubject').value;
            const g = parseFloat(document.getElementById('gradeValue').value);
            const w = parseFloat(document.getElementById('gradeWeight').value);
            if(s && g) db.collection('users').doc(viewUserId).collection('grades').add({subject:s, grade:g, weight:w, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
        }
        function loadGrades() {
            db.collection('users').doc(viewUserId).collection('grades').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const list = document.getElementById('grades-list');
                let html = '';
                const subjects = {};
                snap.forEach(doc => {
                    const d = doc.data();
                    if (!subjects[d.subject]) subjects[d.subject] = {sum:0, wSum:0, grades:[]};
                    subjects[d.subject].sum += d.grade * d.weight;
                    subjects[d.subject].wSum += d.weight;
                    subjects[d.subject].grades.push({id:doc.id, ...d});
                });
                for(const s in subjects) {
                    const avg = (subjects[s].sum / subjects[s].wSum).toFixed(1);
                    html += `<div style="margin-bottom:10px; border-bottom:1px solid #eee;"><b>${s}: ${avg}</b>`;
                    subjects[s].grades.forEach(g => html+=`<div style="font-size:0.8em; display:flex; justify-content:space-between;"><span>${g.grade} (x${g.weight})</span> <span style="cursor:pointer; color:red;" onclick="db.collection('users').doc('${viewUserId}').collection('grades').doc('${g.id}').delete()">x</span></div>`);
                    html += '</div>';
                }
                list.innerHTML = html || 'Geen cijfers';
            });
        }

        /* --- NOTES --- */
        function addNote() {
            const s = document.getElementById('noteSubject').value;
            const d = document.getElementById('noteDate').value;
            const c = document.getElementById('noteContent').value;
            if(s) db.collection('users').doc(viewUserId).collection('subject_notes').add({subject:s, date: d?firebase.firestore.Timestamp.fromDate(new Date(d)):null, content:c, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
        }
        function loadNotes() { 
             db.collection('users').doc(viewUserId).collection('subject_notes').orderBy('createdAt', 'desc').onSnapshot(snap => {
                 const c = document.getElementById('notes-list-container'); c.innerHTML='';
                 snap.forEach(doc => {
                     const d = doc.data();
                     c.innerHTML += `<div style="border:1px solid #eee; padding:10px; margin-bottom:10px; border-radius:8px;"><b>${d.subject}</b><br><small>${d.date?d.date.toDate().toLocaleDateString():''}</small><p>${d.content}</p><button onclick="db.collection('users').doc('${viewUserId}').collection('subject_notes').doc('${doc.id}').delete()" style="color:red; background:none; border:none; padding:0; font-size:0.8em;">Verwijder</button></div>`;
                 });
             });
        }

        /* --- TIMER --- */
        function updateTimerDisplay() { 
            const m = Math.floor(timeLeft/60).toString().padStart(2,'0'), s = (timeLeft%60).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
        }
        function startTimer() { if(!timerInterval) timerInterval = setInterval(() => { if(timeLeft>0){timeLeft--;updateTimerDisplay()}else{stopTimer();alert("Klaar!")} }, 1000); }
        function stopTimer() { clearInterval(timerInterval); timerInterval = null; }
        function resetTimer() { stopTimer(); const val=document.getElementById('timerInput').value; timeLeft=(val?val:25)*60; updateTimerDisplay(); }
        function saveSettings() { const n=document.getElementById('settings-name').value; if(n) auth.currentUser.updateProfile({displayName:n}).then(()=>alert("Opgeslagen")); }
    </script>
</body>
</html>
