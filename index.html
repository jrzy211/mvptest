@@ -1,17 +1,27 @@
<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study-Start Pro</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23007aff'/></svg>" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase SDK's -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Google Gemini SDK (Import Map voor module support) -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        :root {
            --off-white: #fafafa; 
@@ -34,7 +44,7 @@

        /* SIDEBAR */
        #app-sidebar { width: 260px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 25px; flex-shrink: 0; }
        .sidebar-logo { font-size: 1.4em; font-weight: 800; color: var(--primary-color); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .sidebar-logo { font-size: 1.4em; font-weight: 800; color: var(--primary-color); margin-bottom: 40px; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: var(--text-muted); font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background-color: rgba(0, 122, 255, 0.1); color: var(--primary-color); }

@@ -43,24 +53,18 @@
        header { background-color: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; transition: top 0.3s; }

        /* LAYOUTS */
        .page-section { display: none; padding: 30px; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .page-section { display: none; padding: 30px; max-width: 1600px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .page-section.active { display: flex; gap: 30px; flex-direction: column; }
        #page-planning.active { flex-direction: row; }
        #planner-column { flex: 1; min-width: 0; } 
        #tools-column { width: 350px; flex-shrink: 0; }

        /* DASHBOARD GRID */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; width: 100%; }
        .stat-big-number { font-size: 3em; font-weight: 800; color: var(--primary-color); line-height: 1; }
        .xp-bar-container { background: #eee; height: 10px; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary-color), #00c6ff); width: 0%; transition: width 0.5s ease; }

        /* CARDS & UI */
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        h2 { margin-top: 0; margin-bottom: 20px; font-size: 1.6em; letter-spacing: -0.5px; }
        h3 { margin-top: 0; font-size: 1.1em; margin-bottom: 15px; font-weight: 600; }

        input, select, textarea { width: 100%; background-color: #fff; border: 1px solid #ddd; color: var(--text-color); padding: 12px; border-radius: 8px; font-family: inherit; box-sizing: border-box; margin-bottom: 10px; }
        input, select, textarea { width: 100%; background-color: #fff; border: 1px solid #ddd; color: var(--text-color); padding: 10px; border-radius: 8px; font-family: inherit; box-sizing: border-box; margin-bottom: 10px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1); }

        button { width: 100%; background-color: var(--primary-color); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.95em; }
@@ -85,9 +89,9 @@
        .col-bijles { width: 25%; }
        .col-status { width: 60px; text-align: center; padding-left: 5px; padding-right: 5px;}

        .editable-area { width: 100%; min-height: 40px; border: 1px solid transparent; padding: 5px; border-radius: 6px; resize: none; overflow: hidden; }
        .editable-area { width: 100%; min-height: 40px; border: 1px solid transparent; padding: 5px; border-radius: 6px; resize: none; overflow: hidden; font-family: inherit; transition: 0.2s; }
        .editable-area:hover { background-color: #f9f9f9; }
        .editable-area:focus { border-color: var(--primary-color); background: white; }
        .editable-area:focus { border-color: var(--primary-color); background: white; box-shadow: 0 0 0 2px rgba(0,122,255,0.1); }

        .status-container { display: flex; justify-content: center; align-items: center; height: 100%; }
        .status-container input { width: 20px; height: 20px; margin: 0; cursor: pointer; }
@@ -109,15 +113,6 @@
        .chat-input-area input { margin-bottom: 0; border-radius: 20px; }
        .chat-input-area button { width: auto; border-radius: 20px; padding: 10px 20px; }

        /* ZEN MODE */
        body.zen-mode #app-sidebar { margin-left: -260px; }
        body.zen-mode header { top: -100px; }
        body.zen-mode #main-content { background-color: #111; color: #eee; } 
        body.zen-mode .card { background-color: #222; border-color: #333; color: #eee; box-shadow: none; }
        body.zen-mode #zen-exit-btn { display: block !important; }
        #zen-exit-btn { position: fixed; top: 20px; right: 20px; z-index: 2000; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); width: auto; backdrop-filter: blur(5px); display: none; padding: 10px 20px; border-radius: 20px;}


        @media (max-width: 1100px) {
            body { flex-direction: column; height: auto; overflow-y: auto;}
            #app-sidebar { width: 100%; flex-direction: row; overflow-x: auto; height: auto; }
@@ -128,8 +123,6 @@
</head>
<body>

    <button id="zen-exit-btn" onclick="toggleZenMode()">‚úï Sluit Focus Mode</button>

    <!-- LOGIN -->
    <div id="login-page" style="display: none;">
        <div class="login-card">
@@ -144,8 +137,7 @@
    <!-- APP -->
    <nav id="app-sidebar" style="display: none;">
        <div class="sidebar-logo">Study-Start</div>
        <div class="nav-item active" onclick="navigate('dashboard')">üè† Dashboard</div>
        <div class="nav-item" onclick="navigate('planning')">üìÖ Planning</div>
        <div class="nav-item active" onclick="navigate('planning')">üìÖ Planning</div>
        <div class="nav-item" onclick="navigate('chatbot')">ü§ñ AI Tutor</div>
        <div class="nav-item" onclick="navigate('cijfers')">üìä Cijfers</div>
        <div class="nav-item" onclick="navigate('notities')">üìù Notities</div>
@@ -162,34 +154,8 @@
            <button onclick="signOutUser()" class="secondary" style="width: auto; padding: 8px 15px;">Uitloggen</button>
        </header>

        <!-- DASHBOARD -->
        <div id="page-dashboard" class="page-section active">
            <h2>üëã Welkom terug!</h2>
            <div class="dashboard-grid">
                <div class="card">
                    <h3>Jouw Profiel</h3>
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div><div class="stat-big-number" id="dash-level">1</div><div style="color: var(--text-muted);">Level</div></div>
                        <div><div class="stat-big-number" style="color: var(--warning-color);" id="dash-streak">0</div><div style="color: var(--text-muted);">Streak üî•</div></div>
                    </div>
                    <div class="xp-bar-container"><div id="xp-fill" class="xp-bar-fill"></div></div>
                    <p style="font-size: 0.8em; text-align: right; margin-top: 5px; color: var(--text-muted);"><span id="dash-xp">0</span> / 100 XP</p>
                </div>
                <div class="card">
                    <h3>üìÖ Eerstvolgende Deadline</h3>
                    <div id="dash-next-exam"><p style="color: var(--text-muted);">Geen toetsen gepland.</p></div>
                    <button onclick="navigate('planning')" class="secondary" style="margin-top: 15px;">Ga naar Planning</button>
                </div>
                <div class="card">
                    <h3>üöÄ Snelstart</h3>
                    <button onclick="navigate('timer')" style="margin-bottom: 10px;">Start Focus Sessie</button>
                    <button onclick="navigate('chatbot')" class="secondary">Vraag AI Tutor</button>
                </div>
            </div>
        </div>

        <!-- PAGE 1: PLANNING -->
        <div id="page-planning" class="page-section">
        <div id="page-planning" class="page-section active">
            <div id="planner-column">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin:0;">Jouw Planning</h2>
@@ -302,8 +268,6 @@
                    <button onclick="stopTimer()" class="secondary">Pauze</button>
                    <button onclick="resetTimer()" class="secondary">Reset</button>
                </div>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                <button onclick="toggleZenMode()" style="background: #222; color: #fff;">üßò Start Zen Mode</button>
            </div>
        </div>

@@ -323,7 +287,9 @@

    </main>

    <script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        /* CONFIG */
        const firebaseConfig = {
          apiKey: "AIzaSyD_Kg4HjgBpG9QqpEuxfBklPL5-34G3RHI",
@@ -395,27 +361,27 @@
                document.getElementById('auto-planner-card').style.display = 'none';
            }
            initPlanner();
            if(userRole === 'owner') { loadNotes(); loadGrades(); loadUserProfile(); }
            if(userRole === 'owner') { loadNotes(); loadGrades(); }
        }

        function signInWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function signOutUser() { auth.signOut().then(() => window.location.href = window.location.pathname); }
        function navigate(id) {
        window.signInWithGoogle = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
        window.signOutUser = () => auth.signOut().then(() => window.location.href = window.location.pathname);
        window.navigate = (id) => {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${id}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
        };

        /* GEMINI CHATBOT (FIXED MODEL) */
        async function sendMessage() {
        /* GEMINI CHATBOT (SDK) */
        window.sendMessage = async () => {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if(!msg) return;

            addMessage(msg, 'user');
            input.value = '';
            const botMsgDiv = addMessage('Typing...', 'bot');
            const botMsgDiv = addMessage('...', 'bot');

            let apiKey = localStorage.getItem('gemini_key');
            if (!apiKey) {
@@ -424,28 +390,20 @@
            }
            apiKey = apiKey.trim();

            // Gebruik 'gemini-pro' (stabieler en gratis beschikbaar)
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Je bent een bijlesdocent. Hier is de planning van de student: ${globalContext}. De student vraagt: ${msg}` }] }]
                    })
                });
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                if (!response.ok) {
                     const err = await response.json();
                     throw new Error(err.error?.message || response.statusText);
                }

                const data = await response.json();
                const answer = data.candidates[0].content.parts[0].text;
                botMsgDiv.innerHTML = answer.replace(/\n/g, "<br>");
                const prompt = `Je bent een bijlesdocent. Hier is de planning van de student: ${globalContext}. De student vraagt: ${msg}`;
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const text = response.text();
                
                botMsgDiv.innerHTML = text.replace(/\n/g, "<br>");
            } catch (error) {
                botMsgDiv.innerHTML = "Fout: " + error.message;
            }
        }
        };

        function addMessage(text, type) {
            const history = document.getElementById('chat-messages');
@@ -457,27 +415,27 @@
            return div;
        }

        function saveApiKey() {
        window.saveApiKey = () => {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) { localStorage.setItem('gemini_key', key); alert("Key opgeslagen!"); }
        }
        };

        /* COLLAB */
        function addCollaborator() {
        window.addCollaborator = () => {
            const email = document.getElementById('collabEmail').value.toLowerCase().trim();
            if(!email) return;
            db.collection('users').doc(currentUserId).collection('collaborators').doc(email).set({added: new Date()}).then(() => { alert('Toegang!'); document.getElementById('collabEmail').value = ''; });
        }
        };
        function loadCollaborators() {
            db.collection('users').doc(currentUserId).collection('collaborators').onSnapshot(snap => {
                const list = document.getElementById('collaborators-list'); list.innerHTML='';
                snap.forEach(doc => list.innerHTML += `<div class="collab-item"><span>${doc.id}</span> <button onclick="removeCollab('${doc.id}')" class="secondary" style="width:auto; padding:0 5px; font-size:0.8em;">X</button></div>`);
            });
        }
        function removeCollab(e) { if(confirm('Zeker?')) db.collection('users').doc(currentUserId).collection('collaborators').doc(e).delete(); }
        window.removeCollab = (e) => { if(confirm('Zeker?')) db.collection('users').doc(currentUserId).collection('collaborators').doc(e).delete(); };

        /* PLANNER */
        function generateAutoPlanning() {
        window.generateAutoPlanning = () => {
            const vak = document.getElementById('autoVakInput').value;
            const hst = document.getElementById('autoHoofdstukInput').value;
            const dateVal = document.getElementById('autoDatumInput').value;
@@ -503,15 +461,15 @@
                 curr.setDate(curr.getDate()+7);
            }
            batch.commit().then(() => alert("Gepland!"));
        }
        };

        function initPlanner() {
            db.collection('users').doc(viewUserId).collection('planner_items').orderBy('weekStart', 'asc').onSnapshot(snapshot => {
                document.getElementById('loading-indicator').style.display = 'none';
                const tbody = document.getElementById('planner-table-body');
                tbody.innerHTML = '';
                const grouped = {};
                globalContext = ""; // Reset context voor AI
                globalContext = ""; 

                snapshot.forEach(doc => {
                    const data = doc.data(); data.id = doc.id; data.jsDate = data.weekStart.toDate();
@@ -550,55 +508,30 @@
            container.appendChild(row);
        }

        function updateField(id, f, v) { 
            if(userRole !== 'read') {
                db.collection('users').doc(viewUserId).collection('planner_items').doc(id).update({[f]: v});
                if(f==='isAfgerond' && v===true) addXP(10);
            }
        }
        function toggleHoliday(ids, val) { if(userRole !== 'read') { const b=db.batch(); ids.split(',').forEach(id=>b.update(db.collection('users').doc(viewUserId).collection('planner_items').doc(id),{isVakantie:val})); b.commit(); } }
        function deleteItem(docId) { if (userRole !== 'read' && confirm("Item verwijderen?")) db.collection('users').doc(viewUserId).collection('planner_items').doc(docId).delete(); }
        window.updateField = (id, f, v) => { if(userRole !== 'read') db.collection('users').doc(viewUserId).collection('planner_items').doc(id).update({[f]: v}); };
        window.toggleHoliday = (ids, val) => { if(userRole !== 'read') { const b=db.batch(); ids.split(',').forEach(id=>b.update(db.collection('users').doc(viewUserId).collection('planner_items').doc(id),{isVakantie:val})); b.commit(); } };
        window.deleteItem = (docId) => { if (userRole !== 'read' && confirm("Item verwijderen?")) db.collection('users').doc(viewUserId).collection('planner_items').doc(docId).delete(); };
        function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); }

        /* EXPORT */
        function exportToICS() {
        window.exportToICS = () => {
             if(!globalContext) return alert("Geen planning om te exporteren.");
             let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//StudyStart//NL\n";
             // Let op: dit vereist dat we de items cachen, voor nu een simpele alert
             alert("Export functie werkt het beste als je de pagina even ververst zodat alle data geladen is. (Functionaliteit is in deze versie vereenvoudigd)");
        }

        /* GAMIFICATION */
        function loadUserProfile() {
            const userRef = db.collection('users').doc(viewUserId);
            userRef.onSnapshot(doc => {
                const data = doc.data() || { xp: 0, streak: 0 };
                const level = Math.floor(data.xp / 100) + 1;
                const xpProgress = data.xp % 100;
                document.getElementById('dash-level').innerText = level;
                document.getElementById('dash-streak').innerText = data.streak || 0;
                document.getElementById('dash-xp').innerText = data.xp || 0;
                document.getElementById('xp-fill').style.width = `${xpProgress}%`;
            });
        }
        function addXP(amount) {
            db.collection('users').doc(currentUserId).update({ xp: firebase.firestore.FieldValue.increment(amount) });
        }
        };

        /* GRADES & NOTES */
        function addGrade() { const s=document.getElementById('gradeSubject').value, g=parseFloat(document.getElementById('gradeValue').value), w=parseFloat(document.getElementById('gradeWeight').value); if(s&&g) db.collection('users').doc(viewUserId).collection('grades').add({subject:s, grade:g, weight:w, createdAt: firebase.firestore.FieldValue.serverTimestamp()}); }
        window.addGrade = () => { const s=document.getElementById('gradeSubject').value, g=parseFloat(document.getElementById('gradeValue').value), w=parseFloat(document.getElementById('gradeWeight').value); if(s&&g) db.collection('users').doc(viewUserId).collection('grades').add({subject:s, grade:g, weight:w, createdAt: firebase.firestore.FieldValue.serverTimestamp()}); };
        function loadGrades() { db.collection('users').doc(viewUserId).collection('grades').orderBy('createdAt', 'desc').onSnapshot(snap => { const l = document.getElementById('grades-list'); l.innerHTML = ''; snap.forEach(d => l.innerHTML += `<div>${d.data().subject}: ${d.data().grade}</div>`); }); }
        function addNote() { const s=document.getElementById('noteSubject').value, c=document.getElementById('noteContent').value; if(s) db.collection('users').doc(viewUserId).collection('subject_notes').add({subject:s, content:c, createdAt: firebase.firestore.FieldValue.serverTimestamp()}); }
        window.addNote = () => { const s=document.getElementById('noteSubject').value, c=document.getElementById('noteContent').value; if(s) db.collection('users').doc(viewUserId).collection('subject_notes').add({subject:s, content:c, createdAt: firebase.firestore.FieldValue.serverTimestamp()}); };
        function loadNotes() { db.collection('users').doc(viewUserId).collection('subject_notes').orderBy('createdAt', 'desc').onSnapshot(snap => { const l = document.getElementById('notes-list-container'); l.innerHTML = ''; snap.forEach(d => l.innerHTML += `<div class="note-card"><span class="note-subject">${d.data().subject}</span><p>${d.data().content}</p></div>`); }); }

        /* TIMER */
        function updateTimerDisplay() { const m = Math.floor(timeLeft/60).toString().padStart(2,'0'), s = (timeLeft%60).toString().padStart(2,'0'); document.getElementById('timer-display').innerText = `${m}:${s}`; }
        function startTimer() { if(!timerInterval) timerInterval = setInterval(() => { if(timeLeft>0){timeLeft--;updateTimerDisplay()}else{stopTimer();alert("Klaar!")} }, 1000); }
        function stopTimer() { clearInterval(timerInterval); timerInterval = null; }
        function resetTimer() { stopTimer(); const val=document.getElementById('timerInput').value; timeLeft=(val?val:25)*60; updateTimerDisplay(); }
        
        function toggleZenMode() { document.body.classList.toggle('zen-mode'); }
        function saveSettings() { const n=document.getElementById('settings-name').value; if(n) auth.currentUser.updateProfile({displayName:n}).then(()=>alert("Opgeslagen")); }
        window.startTimer = () => { if(!timerInterval) timerInterval = setInterval(() => { if(timeLeft>0){timeLeft--;updateTimerDisplay()}else{stopTimer();alert("Klaar!")} }, 1000); };
        window.stopTimer = () => { clearInterval(timerInterval); timerInterval = null; };
        window.resetTimer = () => { window.stopTimer(); const val=document.getElementById('timerInput').value; timeLeft=(val?val:25)*60; updateTimerDisplay(); };
    </script>
</body>
</html>
