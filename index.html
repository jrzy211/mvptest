<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study-Start Pro</title>
    
    <!-- FAVICON -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23007aff'/></svg>" type="image/svg+xml">
    
    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- GOOGLE GEMINI SDK -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        :root {
            --off-white: #fafafa; 
            --bg-color: #f0f2f5; 
            --sidebar-bg: var(--off-white);
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-muted: #666666;
            --primary-color: #007aff; 
            --primary-hover: #005bb5;
            --border-color: #e4e6eb;
            --table-header-bg: #f8f9fa;
            --success-color: #34c759;
            --holiday-bg: #fff9e6; 
            --chat-user-bg: #007aff;
            --chat-bot-bg: #f1f3f5;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        #app-sidebar { width: 260px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 25px; flex-shrink: 0; }
        .sidebar-logo { font-size: 1.4em; font-weight: 800; color: var(--primary-color); margin-bottom: 40px; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: var(--text-muted); font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background-color: rgba(0, 122, 255, 0.1); color: var(--primary-color); }

        /* CONTENT */
        #main-content { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; position: relative; }
        header { background-color: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; transition: top 0.3s; }
        
        /* LAYOUTS */
        .page-section { display: none; padding: 30px; max-width: 1600px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .page-section.active { display: flex; gap: 30px; flex-direction: column; }
        #page-planning.active { flex-direction: row; }
        #planner-column { flex: 1; min-width: 0; } 
        #tools-column { width: 350px; flex-shrink: 0; }

        /* CARDS & UI */
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        h2 { margin-top: 0; margin-bottom: 20px; font-size: 1.6em; letter-spacing: -0.5px; }
        h3 { margin-top: 0; font-size: 1.1em; margin-bottom: 15px; font-weight: 600; }
        
        input, select, textarea { width: 100%; background-color: #fff; border: 1px solid #ddd; color: var(--text-color); padding: 10px; border-radius: 8px; font-family: inherit; box-sizing: border-box; margin-bottom: 10px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1); }

        button { width: 100%; background-color: var(--primary-color); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.95em; }
        button:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        button.secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); }
        button.secondary:hover { background-color: #f5f5f5; color: var(--text-color); transform: none; }

        /* LOGIN */
        #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: flex; justify-content: center; align-items: center; background-color: var(--bg-color); }
        .login-card { background: white; padding: 50px; border-radius: 24px; text-align: center; width: 100%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }

        /* TABLE */
        .table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 12px; background: white; }
        .studie-tabel { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 800px; }
        .studie-tabel th { background-color: var(--table-header-bg); color: var(--text-muted); text-transform: uppercase; font-size: 0.75em; padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .studie-tabel td { padding: 15px; border-bottom: 1px solid var(--border-color); vertical-align: top; }
        .studie-tabel tr:last-child td { border-bottom: none; }
        
        .col-week { width: 12%; font-weight: 700; color: var(--primary-color); }
        .col-vak { width: 15%; font-weight: 600; }
        .col-thuis { width: 40%; } 
        .col-bijles { width: 25%; }
        .col-status { width: 60px; text-align: center; padding-left: 5px; padding-right: 5px;}

        .editable-area { width: 100%; min-height: 40px; border: 1px solid transparent; padding: 5px; border-radius: 6px; resize: none; overflow: hidden; }
        .editable-area:hover { background-color: #f9f9f9; }
        .editable-area:focus { border-color: var(--primary-color); background: white; box-shadow: 0 0 0 2px rgba(0,122,255,0.1); }

        .status-container { display: flex; justify-content: center; align-items: center; height: 100%; }
        .status-container input { width: 20px; height: 20px; margin: 0; cursor: pointer; }
        
        tr.is-holiday td { background-color: var(--holiday-bg); color: #967d00; }
        
        .collab-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em; }

        /* TIMER */
        #timer-display { font-size: 4em; font-weight: 700; color: var(--primary-color); text-align: center; margin: 20px 0; }

        /* CHATBOT */
        #chat-container { display: flex; flex-direction: column; height: 600px; background: #fff; border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; position: relative;}
        #chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background-color: #fcfcfc; }
        .message { max-width: 75%; padding: 12px 16px; border-radius: 12px; font-size: 0.95em; line-height: 1.5; position: relative; }
        .message.user { align-self: flex-end; background-color: var(--chat-user-bg); color: white; border-bottom-right-radius: 2px; }
        .message.bot { align-self: flex-start; background-color: var(--chat-bot-bg); color: #333; border-bottom-left-radius: 2px; }
        .chat-input-area { padding: 15px; background: #fff; border-top: 1px solid var(--border-color); display: flex; gap: 10px; align-items: center; }
        .chat-input-area input { margin-bottom: 0; border-radius: 20px; }
        .chat-input-area button { width: auto; border-radius: 20px; padding: 10px 20px; }

        @media (max-width: 1100px) {
            body { flex-direction: column; height: auto; overflow-y: auto;}
            #app-sidebar { width: 100%; flex-direction: row; overflow-x: auto; height: auto; }
            .page-section.active { flex-direction: column; }
            #tools-column { width: 100%; order: -1; }
        }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-page" style="display: none;">
        <div class="login-card">
            <h1 style="color: var(--primary-color);">Study-Start</h1>
            <p>Log in om je planner te openen.</p>
            <button onclick="signInWithGoogle()" style="background: white; color: #333; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Inloggen met Google
            </button>
        </div>
    </div>

    <!-- APP -->
    <nav id="app-sidebar" style="display: none;">
        <div class="sidebar-logo">Study-Start</div>
        <div class="nav-item active" onclick="navigate('planning')">üìÖ Planning</div>
        <div class="nav-item" onclick="navigate('chatbot')">ü§ñ AI Tutor</div>
        <div class="nav-item" onclick="navigate('cijfers')">üìä Cijfers</div>
        <div class="nav-item" onclick="navigate('notities')">üìù Notities</div>
        <div class="nav-item" onclick="navigate('timer')">‚è±Ô∏è Timer</div>
        <div class="nav-item" onclick="navigate('instellingen')">‚öôÔ∏è Instellingen</div>
    </nav>

    <main id="main-content" style="display: none;">
        <header>
            <div id="shared-badge" style="display: none; background: #fff3cd; color: #856404; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; margin-right: 15px; border: 1px solid #ffeeba;">
                üëÅÔ∏è Je kijkt mee
            </div>
            <span id="user-display-name" style="font-weight: 600; margin-right: 15px;">Gast</span>
            <button onclick="signOutUser()" class="secondary" style="width: auto; padding: 8px 15px;">Uitloggen</button>
        </header>

        <!-- PAGE 1: PLANNING -->
        <div id="page-planning" class="page-section active">
            <div id="planner-column">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin:0;">Jouw Planning</h2>
                    <button onclick="exportToICS()" class="secondary" style="width: auto; font-size: 0.8em; padding: 8px 15px;">üì§ Exporteer Agenda</button>
                </div>
                <div id="loading-indicator" style="color: var(--text-muted);">Laden...</div>
                <div class="table-container">
                    <table class="studie-tabel">
                        <thead>
                            <tr>
                                <th class="col-week">Week</th>
                                <th class="col-vak">Vak</th>
                                <th class="col-thuis">Thuis Doen</th>
                                <th class="col-bijles">Bijles</th>
                                <th class="col-status"></th>
                            </tr>
                        </thead>
                        <tbody id="planner-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="tools-column">
                <div class="card" id="share-card" style="border: 1px solid var(--primary-color);">
                    <h3>ü§ù Samenwerken</h3>
                    <p style="font-size: 0.9em; color: var(--text-muted);">Voeg docent/ouder toe:</p>
                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                        <input type="email" id="collabEmail" placeholder="docent@email.com" style="margin-bottom:0;">
                        <button onclick="addCollaborator()" style="width: auto;">+</button>
                    </div>
                    <div id="collaborators-list"></div>
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                    <p style="font-size: 0.85em; color: var(--text-muted);">Deel-Link:</p>
                    <input type="text" id="shareLinkInput" readonly style="font-size: 0.8em; color: var(--primary-color); cursor: copy; background: #f0f8ff; border-color: #b3d7ff;" onclick="this.select(); document.execCommand('copy'); alert('Link gekopieerd!');">
                </div>
                <div class="card" id="auto-planner-card">
                    <h3>‚ö° Nieuwe Toets</h3>
                    <input type="text" list="vakken-list" id="autoVakInput" placeholder="Vak">
                    <datalist id="vakken-list">
                        <option value="Wiskunde"><option value="Nederlands"><option value="Engels"><option value="Geschiedenis"><option value="Aardrijkskunde">
                    </datalist>
                    <select id="autoHoofdstukInput">
                        <option value="" disabled selected>Hoofdstuk</option>
                        <option value="H1">H1</option><option value="H2">H2</option><option value="H3">H3</option>
                        <option value="H4">H4</option><option value="H5">H5</option><option value="H6">H6</option>
                    </select>
                    <input type="date" id="autoDatumInput">
                    <button onclick="generateAutoPlanning()">Inplannen</button>
                </div>
            </div>
        </div>

        <!-- PAGE 2: AI CHATBOT -->
        <div id="page-chatbot" class="page-section">
            <div style="max-width: 800px; margin: 0 auto; width: 100%;">
                <h2>ü§ñ AI Tutor (Powered by Gemini)</h2>
                <div id="chat-container">
                    <div id="chat-messages">
                        <div class="message bot">
                            Hallo! Ik ben je AI Tutor. Ik gebruik <strong>Google Gemini</strong>. Stel je vraag!
                            <br><small>(Zorg dat je API Key is ingesteld bij 'Instellingen')</small>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" placeholder="Typ je vraag..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()">Verstuur</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE 3: CIJFERS -->
        <div id="page-cijfers" class="page-section">
            <div style="flex: 1;">
                <h2>Mijn Cijfers</h2>
                <div class="card">
                    <h3>Cijfer Toevoegen</h3>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="gradeSubject" placeholder="Vak">
                        <input type="number" id="gradeValue" placeholder="Cijfer" step="0.1">
                        <input type="number" id="gradeWeight" placeholder="Weging" value="1">
                    </div>
                    <button onclick="addGrade()">Opslaan</button>
                </div>
                <div class="card"><h3>Overzicht</h3><div id="grades-list">Laden...</div></div>
            </div>
        </div>

        <!-- PAGE 4: NOTITIES -->
        <div id="page-notities" class="page-section">
            <div style="width: 300px;">
                <div class="card">
                    <h3>Nieuwe Notitie</h3>
                    <input type="text" id="noteSubject" placeholder="Vak">
                    <input type="date" id="noteDate">
                    <textarea id="noteContent" style="height: 150px;" placeholder="Inhoud..."></textarea>
                    <button onclick="addNote()">Opslaan</button>
                </div>
            </div>
            <div style="flex: 1;"><h2>Mijn Notities</h2><div id="notes-list-container">Laden...</div></div>
        </div>

        <!-- PAGE 5: TIMER -->
        <div id="page-timer" class="page-section" style="align-items: center; text-align: center;">
            <h2>Focus Timer</h2>
            <div class="card" style="max-width: 400px; width: 100%;">
                <input type="number" id="timerInput" value="25" min="1" style="text-align: center; font-size: 1.2em; width: 80px; margin: 0 auto 10px;">
                <div id="timer-display">25:00</div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="startTimer()">Start</button>
                    <button onclick="stopTimer()" class="secondary">Pauze</button>
                    <button onclick="resetTimer()" class="secondary">Reset</button>
                </div>
            </div>
        </div>

        <!-- INSTELLINGEN -->
        <div id="page-instellingen" class="page-section">
            <h2>Instellingen</h2>
            <div class="card" style="max-width: 600px;">
                <h3>Google Gemini API Key</h3>
                <p style="font-size: 0.9em; color: var(--text-muted);">
                    Plak hier je <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio Key</a>. 
                </p>
                <input type="password" id="apiKeyInput" placeholder="AIza...">
                <button onclick="saveApiKey()" style="width: auto;">Sleutel Opslaan</button>
            </div>
        </div>

    </main>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        /* CONFIG */
        const firebaseConfig = {
          apiKey: "AIzaSyD_Kg4HjgBpG9QqpEuxfBklPL5-34G3RHI",
          authDomain: "study-start-c510c.firebaseapp.com",
          projectId: "study-start-c510c",
          storageBucket: "study-start-c510c.firebasestorage.app",
          messagingSenderId: "960911379164",
          appId: "1:960911379164:web:ad8648cfa2fe65f8620219"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUserId = null;
        let viewUserId = null;
        let userRole = 'owner'; 
        let timerInterval = null;
        let timeLeft = 25 * 60;
        let globalContext = ""; 

        /* AUTH & INIT */
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('user-display-name').innerText = user.email;
                
                const params = new URLSearchParams(window.location.search);
                const targetUid = params.get('uid');

                if (targetUid && targetUid !== currentUserId) {
                    viewUserId = targetUid;
                    checkAccess(targetUid, user.email);
                } else {
                    viewUserId = currentUserId;
                    userRole = 'owner';
                    initApp();
                }

                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-sidebar').style.display = 'flex';
                document.getElementById('main-content').style.display = 'flex';
                document.getElementById('shareLinkInput').value = `${window.location.origin}${window.location.pathname}?uid=${currentUserId}`;

                const savedKey = localStorage.getItem('gemini_key');
                if(savedKey) document.getElementById('apiKeyInput').value = savedKey;

            } else {
                document.getElementById('login-page').style.display = 'flex';
            }
        });

        function checkAccess(targetUid, email) {
            db.collection('users').doc(targetUid).collection('collaborators').doc(email.toLowerCase()).get()
            .then(doc => {
                if (doc.exists) {
                    userRole = 'edit'; 
                    initApp();
                } else {
                    alert("Geen toegang.");
                    window.location.href = window.location.pathname;
                }
            });
        }

        function initApp() {
            if (userRole !== 'owner') {
                document.getElementById('shared-badge').style.display = 'inline-block';
                document.getElementById('share-card').style.display = 'none';
                document.getElementById('auto-planner-card').style.display = 'none';
            }
            initPlanner();
            if(userRole === 'owner') { loadNotes(); loadGrades(); }
        }

        window.signInWithGoogle = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
        window.signOutUser = () => auth.signOut().then(() => window.location.href = window.location.pathname);
        window.navigate = (id) => {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${id}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        /* GEMINI CHATBOT (SDK) */
        window.sendMessage = async () => {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if(!msg) return;
            
            addMessage(msg, 'user');
            input.value = '';
            const botMsgDiv = addMessage('Typing...', 'bot');
            
            let apiKey = localStorage.getItem('gemini_key');
            if (!apiKey) {
                botMsgDiv.innerHTML = "Geen Gemini Key. Stel in bij 'Instellingen'.";
                return;
            }
            apiKey = apiKey.trim();

            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                // FIX: Gebruik 'gemini-pro' (werkt stabiel met SDK)
                const model = genAI.getGenerativeModel({ model: "gemini-pro" });
                
                const prompt = `Je bent een bijlesdocent. Hier is de planning van de student: ${globalContext}. De student vraagt: ${msg}`;
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const text = response.text();
                
                botMsgDiv.innerHTML = text.replace(/\n/g, "<br>");
            } catch (error) {
                console.error("Gemini Error:", error);
                botMsgDiv.innerHTML = "Fout: " + error.message;
            }
        };

        function addMessage(text, type) {
            const history = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = text;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return div;
        }
        
        window.saveApiKey = () => {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) { localStorage.setItem('gemini_key', key); alert("Key opgeslagen!"); }
        };

        /* COLLAB */
        window.addCollaborator = () => {
            const email = document.getElementById('collabEmail').value.toLowerCase().trim();
            if(!email) return;
            db.collection('users').doc(currentUserId).collection('collaborators').doc(email).set({added: new Date()}).then(() => { alert('Toegang!'); document.getElementById('collabEmail').value = ''; });
        };
        function loadCollaborators() {
            db.collection('users').doc(currentUserId).collection('collaborators').onSnapshot(snap => {
                const list = document.getElementById('collaborators-list'); list.innerHTML='';
                snap.forEach(doc => list.innerHTML += `<div class="collab-item"><span>${doc.id}</span> <button onclick="removeCollab('${doc.id}')" class="secondary" style="width:auto; padding:0 5px; font-size:0.8em;">X</button></div>`);
            });
        }
        window.removeCollab = (e) => { if(confirm('Zeker?')) db.collection('users').doc(currentUserId).collection('collaborators').doc(e).delete(); };

        /* PLANNER */
        window.generateAutoPlanning = () => {
            const vak = document.getElementById('autoVakInput').value;
            const hst = document.getElementById('autoHoofdstukInput').value;
            const dateVal = document.getElementById('autoDatumInput').value;
            if(!vak || !hst || !dateVal) return alert("Vul alles in.");
            
            const toetsDate = new Date(dateVal);
            let curr = new Date(); curr.setDate(curr.getDate() - curr.getDay() + 1);
            const batch = db.batch();
            
            while(curr <= toetsDate) {
                 const end = new Date(curr); end.setDate(curr.getDate()+6);
                 const id = `${vak}-${curr.getTime()}`;
                 batch.set(db.collection('users').doc(viewUserId).collection('planner_items').doc(id), {
                     weekStart: firebase.firestore.Timestamp.fromDate(curr),
                     weekEnd: firebase.firestore.Timestamp.fromDate(end),
                     weekNummer: getWeekNumber(curr),
                     vak: vak,
                     thuisDoen: `Oefenen ${vak} ${hst}`,
                     bijlesDoen: `Vragen ${hst}`,
                     isAfgerond: false, isVakantie: false, isBijlesNodig: true,
                     groupKey: `${curr.getFullYear()}-${getWeekNumber(curr)}`
                 });
                 curr.setDate(curr.getDate()+7);
            }
            batch.commit().then(() => alert("Gepland!"));
        };

        function initPlanner() {
            db.collection('users').doc(viewUserId).collection('planner_items').orderBy('weekStart', 'asc').onSnapshot(snapshot => {
                document.getElementById('loading-indicator').style.display = 'none';
                const tbody = document.getElementById('planner-table-body');
                tbody.innerHTML = '';
                const grouped = {};
                globalContext = ""; // Reset context voor AI

                snapshot.forEach(doc => {
                    const data = doc.data(); data.id = doc.id; data.jsDate = data.weekStart.toDate();
                    const key = data.groupKey || `${data.jsDate.getFullYear()}-${data.weekNummer}`;
                    if(!grouped[key]) grouped[key] = []; grouped[key].push(data);
                    
                    globalContext += `Week ${data.weekNummer}: ${data.vak} (${data.thuisDoen}). `;
                });
                const keys = Object.keys(grouped).sort((a,b) => grouped[a][0].jsDate - grouped[b][0].jsDate);
                keys.forEach(key => renderGroupedRow(tbody, grouped[key], userRole !== 'read'));
            });
        }

        function renderGroupedRow(container, items, isEditable) {
            const first = items[0];
            const weekEndStr = first.weekEnd.toDate().toLocaleDateString('nl-NL', {day: 'numeric', month: 'short'});
            const isHoliday = items.some(i => i.isVakantie);
            const row = document.createElement('tr');
            if (isHoliday) row.classList.add('is-holiday');

            let vakHtml='', thuisHtml='', bijlesHtml='', statusHtml='';

            items.forEach((item, index) => {
                const border = index < items.length - 1 ? 'border-bottom: 1px dashed var(--border-color); padding-bottom: 10px; margin-bottom: 10px;' : '';
                vakHtml += `<div style="${border} font-weight:600; padding-top:5px;">${item.vak}</div>`;
                thuisHtml += `<div style="${border}"><textarea class="editable-area" onblur="updateField('${item.id}', 'thuisDoen', this.value)" ${!isEditable || isHoliday ? 'disabled' : ''}>${isHoliday ? 'VAKANTIE!' : item.thuisDoen}</textarea></div>`;
                const bijlesClass = item.isBijlesNodig === false ? 'opacity:0.5; text-decoration:line-through;' : '';
                bijlesHtml += `<div style="${border}; display:flex; gap:5px; ${bijlesClass}"><label class="switch" style="transform:scale(0.6);"><input type="checkbox" ${item.isBijlesNodig!==false?'checked':''} onchange="updateField('${item.id}', 'isBijlesNodig', this.checked)" ${!isEditable ? 'disabled' : ''}><span class="slider"></span></label><textarea class="editable-area" onblur="updateField('${item.id}', 'bijlesDoen', this.value)" ${!isEditable || isHoliday ? 'disabled' : ''}>${isHoliday ? '-' : item.bijlesDoen}</textarea></div>`;
                statusHtml += `<div style="${border}; display:flex; justify-content:center; height:40px; align-items:center;"><div class="status-container"><input type="checkbox" ${item.isAfgerond ? 'checked' : ''} onchange="updateField('${item.id}', 'isAfgerond', this.checked)" ${!isEditable ? 'disabled' : ''}></div>${isEditable ? `<button onclick="deleteItem('${item.id}')" style="margin-left:5px; background:transparent; color:#ccc; padding:0; width:auto;">&times;</button>` : ''}</div>`;
            });

            row.innerHTML = `
                <td class="col-week" style="border-right: 1px solid var(--border-color);">WEEK ${first.weekNummer}<br><span style="font-size:0.8em; color:var(--text-muted)">t/m zo ${weekEndStr}</span><div style="margin-top:5px;"><label style="font-size:0.7em;"><input type="checkbox" ${isHoliday?'checked':''} onchange="toggleHoliday('${items.map(i=>i.id).join(',')}', this.checked)" ${!isEditable ? 'disabled' : ''}> Vakantie</label></div></td>
                <td class="col-vak">${vakHtml}</td><td class="col-thuis">${thuisHtml}</td><td class="col-bijles">${bijlesHtml}</td><td class="col-status">${statusHtml}</td>
            `;
            container.appendChild(row);
        }

        window.updateField = (id, f, v) => { if(userRole !== 'read') db.collection('users').doc(viewUserId).collection('planner_items').doc(id).update({[f]: v}); };
        window.toggleHoliday = (ids, val) => { if(userRole !== 'read') { const b=db.batch(); ids.split(',').forEach(id=>b.update(db.collection('users').doc(viewUserId).collection('planner_items').doc(id),{isVakantie:val})); b.commit(); } };
        window.deleteItem = (docId) => { if (userRole !== 'read' && confirm("Item verwijderen?")) db.collection('users').doc(viewUserId).collection('planner_items').doc(docId).delete(); };
        function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); }

        /* EXPORT */
        window.exportToICS = () => {
             if(!globalContext) return alert("Geen planning om te exporteren.");
             let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//StudyStart//NL\n";
             // Let op: dit vereist dat we de items cachen, voor nu een simpele alert
             alert("Export functie werkt het beste als je de pagina even ververst zodat alle data geladen is. (Functionaliteit is in deze versie vereenvoudigd)");
        };

        /* GRADES & NOTES */
        window.addGrade = () => { const s=document.getElementById('gradeSubject').value, g=parseFloat(document.getElementById('gradeValue').value), w=parseFloat(document.getElementById('gradeWeight').value); if(s&&g) db.collection('users').doc(viewUserId).collection('grades').add({subject:s, grade:g, weight:w, createdAt: firebase.firestore.FieldValue.serverTimestamp()}); };
        function loadGrades() { db.collection('users').doc(viewUserId).collection('grades').orderBy('createdAt', 'desc').onSnapshot(snap => { const l = document.getElementById('grades-list'); l.innerHTML = ''; snap.forEach(d => l.innerHTML += `<div>${d.data().subject}: ${d.data().grade}</div>`); }); }
        window.addNote = () => { const s=document.getElementById('noteSubject').value, c=document.getElementById('noteContent').value; if(s) db.collection('users').doc(viewUserId).collection('subject_notes').add({subject:s, content:c, createdAt: firebase.firestore.FieldValue.serverTimestamp()}); };
        function loadNotes() { db.collection('users').doc(viewUserId).collection('subject_notes').orderBy('createdAt', 'desc').onSnapshot(snap => { const l = document.getElementById('notes-list-container'); l.innerHTML = ''; snap.forEach(d => l.innerHTML += `<div class="note-card"><span class="note-subject">${d.data().subject}</span><p>${d.data().content}</p></div>`); }); }

        /* TIMER */
        function updateTimerDisplay() { const m = Math.floor(timeLeft/60).toString().padStart(2,'0'), s = (timeLeft%60).toString().padStart(2,'0'); document.getElementById('timer-display').innerText = `${m}:${s}`; }
        window.startTimer = () => { if(!timerInterval) timerInterval = setInterval(() => { if(timeLeft>0){timeLeft--;updateTimerDisplay()}else{stopTimer();alert("Klaar!")} }, 1000); };
        window.stopTimer = () => { clearInterval(timerInterval); timerInterval = null; };
        window.resetTimer = () => { window.stopTimer(); const val=document.getElementById('timerInput').value; timeLeft=(val?val:25)*60; updateTimerDisplay(); };
    </script>
</body>
</html>
