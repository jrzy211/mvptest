<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study-Start - Met Calendar</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23FF8C00'/></svg>" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <style>
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        #login-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            padding: 20px;
            background-color: #ffffff;
        }

        #planner-page {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        #planner-content-wrapper {
            display: flex;
            gap: 20px;
            padding: 20px;
            flex-grow: 1;
        }

        #main-planner-area {
            flex: 2;
            min-width: 50%;
        }

        #calendar-sidebar {
            flex: 1;
            min-width: 350px;
            max-width: 500px;
        }
        
        .card {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .planning-form-container input, 
        .planning-form-container select, 
        .planning-form-container button,
        .planning-form-container textarea { 
            padding: 12px; 
            border: 1px solid #ddd;
            border-radius: 5px; 
            font-size: 1em;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .planning-form-container button {
            background-color: #ff8c00; 
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 700; 
            font-size: 1.1em; 
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15); 
        }
        .planning-form-container button:hover {
            background-color: #e67e22;
            transform: translateY(-1px);
        }
        
        header {
            width: 100%;
            background-color: #ff8c00;
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        header button {
            background-color: white;
            color: #ff8c00;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .login-card h1 {
            color: #ff8c00; 
            margin-bottom: 25px;
            font-size: 2em; 
            font-weight: 500;
        }
        
        #google-login-button {
            background-color: white; 
            color: #444; 
            padding: 12px 25px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 1.1em; 
            font-weight: 500;
            transition: background-color 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            margin: 25px auto 0 auto; 
            box-shadow: 0 2px 6px 0 rgba(0,0,0,.15); 
        }

        #google-login-button:hover {
            background-color: #f0f0f0;
            box-shadow: 0 4px 10px 0 rgba(0,0,0,.2);
        }

        .google-icon { 
            width: 24px; 
            height: 24px;
            margin-right: 12px;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="%23FFC107" d="M43.61 20.08v4.92h-18.06c0 5.4 3.82 9.87 9.17 10.87-2.67 1.83-6 2.92-9.61 2.92-10.74 0-19.45-8.71-19.45-19.45S14.26 5.83 25 5.83c5.44 0 9.77 2.22 12.87 5.17l-3.69 3.69c-2.18-1.95-4.99-3.21-9.18-3.21-6.9 0-12.55 5.65-12.55 12.55s5.65 12.55 12.55 12.55c7.34 0 10.32-5.45 11.23-8.22h-11.23V20.08z"/></svg>');
            background-size: cover;
        }

        .task-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .task-item {
            padding: 12px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            border-left: 4px solid #ff8c00;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-item.completed {
            border-left-color: #27ae60;
            background-color: #e6ffe6;
        }

        .task-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.3);
            accent-color: #27ae60;
            cursor: pointer;
        }

        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .calendar-embed {
            width: 100%;
            height: 500px;
            border: 0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .upcoming-events {
            max-height: 300px;
            overflow-y: auto;
        }

        .event-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #fff4e6;
            border-left: 3px solid #ff8c00;
            border-radius: 4px;
            font-size: 0.95em;
        }

        .event-time {
            font-weight: 600;
            color: #ff8c00;
            display: block;
            margin-bottom: 4px;
        }

        .add-to-calendar-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .calendar-sync-notice {
            background-color: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        @media (max-width: 1024px) {
            #planner-content-wrapper {
                flex-direction: column;
            }
            #calendar-sidebar {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>

    <div id="login-page" style="display: none;">
        <div class="card login-card">
            <h1>Welkom bij Study-Start</h1>
            <p>Jouw persoonlijke studieplanner met Google Calendar integratie.</p>
            
            <button id="google-login-button" onclick="signInWithGoogle()">
                <div class="google-icon"></div>
                Inloggen met Google
            </button>

            <p id="login-status-splash" style="margin-top: 20px; font-size: 0.9em; color: #888;">Controleert inlogstatus...</p>
        </div>
    </div>

    <div id="planner-page" style="display: none;">
        <header>
            <h1>üìö Study-Start</h1>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="login-status-header" style="font-size: 0.9em;"></span>
                <button onclick="signOutUser()">Uitloggen</button>
            </div>
        </header>

        <div id="planner-content-wrapper">
            
            <!-- LINKER KOLOM: TAKEN & PLANNING -->
            <div id="main-planner-area">
                <p id="welkom-boodschap" style="font-size: 1.2em; color: #ff8c00; font-weight: 500; margin-bottom: 20px;">Welkom!</p>
                
                <!-- NIEUWE TAAK TOEVOEGEN -->
                <div class="card">
                    <h2>‚ûï Nieuwe Studietaak</h2>
                    <div class="planning-form-container">
                        <input type="text" id="vakInput" placeholder="Vak (bijv. Wiskunde)" required>
                        <input type="text" id="onderwerpInput" placeholder="Onderwerp (bijv. H3: Integralen)" required>
                        <input type="date" id="datumInput" required>
                        <textarea id="notitiesInput" placeholder="Extra notities (optioneel)" rows="2"></textarea>
                        <label style="display: flex; align-items: center; margin-bottom: 10px;">
                            <input type="checkbox" id="addToCalendarCheck" style="width: auto; margin-right: 8px;">
                            <span>Automatisch toevoegen aan Google Calendar</span>
                        </label>
                        <button onclick="saveNewTask()">Taak Opslaan</button>
                    </div>
                    <p id="feedback-message" style="color: red; margin-top: 10px;"></p>
                </div>

                <!-- TAKEN LIJST -->
                <div class="card">
                    <h2>üìã Mijn Studietaken</h2>
                    <div id="tasks-list" class="task-list">
                        <p style="font-style: italic; color: #888;">Laden...</p>
                    </div>
                </div>
            </div>
            
            <!-- RECHTER KOLOM: GOOGLE CALENDAR -->
            <div id="calendar-sidebar">
                
                <div class="calendar-sync-notice">
                    ‚ÑπÔ∏è <strong>Tip:</strong> Taken die je hier aanmaakt kunnen automatisch naar je Google Calendar!
                </div>

                <!-- GOOGLE CALENDAR EMBED -->
                <div class="card">
                    <h3>üìÖ Mijn Google Calendar</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                        Pas je calendar ID aan in de code voor jouw eigen agenda.
                    </p>
                    <iframe id="calendar-embed" class="calendar-embed" 
                            src="https://calendar.google.com/calendar/embed?height=500&wkst=2&bgcolor=%23ffffff&ctz=Europe%2FAmsterdam&showTitle=0&showPrint=0&showTabs=0&showCalendars=0"
                            frameborder="0" scrolling="no"></iframe>
                </div>

                <!-- AANKOMENDE EVENTS -->
                <div class="card">
                    <h3>üîî Aankomende Events</h3>
                    <div id="upcoming-events" class="upcoming-events">
                        <p style="font-style: italic; color: #888;">Verbind met Calendar API voor live events...</p>
                    </div>
                </div>

                <!-- SHARING SECTIE -->
                <div class="card" id="sharing-owner-card">
                    <h3>ü§ù Deel Toegang</h3>
                    <p style="font-size: 0.9em; margin-bottom: 10px;">Docent/ouder e-mail:</p>
                    <div style="display: flex; gap: 5px;">
                        <input type="email" id="docentEmailInput" placeholder="docent@voorbeeld.nl" style="flex-grow: 1;">
                        <button onclick="addAccessByEmail()" style="background-color: #2ecc71; width: auto; padding: 10px 15px;">Toevoegen</button>
                    </div>
                    <p id="share-feedback" style="font-size: 0.8em; margin-top: 10px;"></p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyD_Kg4HjgBpG9QqpEuxfBklPL5-34G3RHI",
          authDomain: "study-start-c510c.firebaseapp.com",
          projectId: "study-start-c510c",
          storageBucket: "study-start-c510c.firebasestorage.app",
          messagingSenderId: "960911379164",
          appId: "1:960911379164:web:ad8648cfa2fe65f8620219",
          measurementId: "G-Z4YN3HVQTR"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore(); 
        
        let currentUserId = null;
        let currentUserEmail = null;
        let activeUserId = null;
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;

        // GOOGLE CALENDAR API CONFIG (Je moet dit aanpassen met jouw eigen credentials)
        const CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com';
        const API_KEY = 'YOUR_API_KEY';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';

        // PAGE SWITCHING
        function showPage(pageId) {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('planner-page').style.display = 'none';
            
            if (pageId === 'login-page') {
                document.getElementById(pageId).style.display = 'flex'; 
            } else {
                document.getElementById(pageId).style.display = 'block'; 
            }
        }

        // AUTH STATE
        function handleUser(user) {
            if (user) {
                currentUserId = user.uid; 
                currentUserEmail = user.email.toLowerCase();
                activeUserId = currentUserId;
                
                document.getElementById('welkom-boodschap').innerText = `Welkom terug, ${user.displayName.split(' ')[0]}! üëã`;
                document.getElementById('login-status-header').innerText = `${user.email}`;
                
                showPage('planner-page');
                loadTasks(activeUserId);
                updateCalendarEmbed(user.email);
            } else {
                currentUserId = null;
                showPage('login-page');
            }
        }
        
        auth.onAuthStateChanged(handleUser);

        function signInWithGoogle() {
          const provider = new firebase.auth.GoogleAuthProvider();
          provider.addScope('https://www.googleapis.com/auth/calendar.events');
          auth.signInWithPopup(provider).catch((error) => {
            console.error("Login Error:", error.message);
            alert(`Fout bij inloggen: ${error.message}`);
          });
        }

        function signOutUser() {
            auth.signOut().then(() => {
                window.location.reload();
            });
        }

        // UPDATE CALENDAR EMBED
        function updateCalendarEmbed(email) {
            // Voor een persoonlijke calendar moet je de calendar ID gebruiken (meestal is dit het email adres)
            // Je kunt ook een public calendar ID gebruiken
            const calendarId = encodeURIComponent(email);
            const embedUrl = `https://calendar.google.com/calendar/embed?height=500&wkst=2&bgcolor=%23ffffff&ctz=Europe%2FAmsterdam&src=${calendarId}&color=%23039BE5&showTitle=0&showPrint=0&showTabs=0&showCalendars=0`;
            document.getElementById('calendar-embed').src = embedUrl;
        }

        // LOAD TASKS
        function loadTasks(userId) {
            const tasksRef = db.collection('users').doc(userId).collection('tasks');
            
            tasksRef.orderBy('datum', 'asc').onSnapshot(snapshot => {
                const tasksList = document.getElementById('tasks-list');
                tasksList.innerHTML = '';
                
                if (snapshot.empty) {
                    tasksList.innerHTML = '<p style="font-style: italic; color: #888;">Nog geen taken toegevoegd.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const task = doc.data();
                    const taskDiv = document.createElement('div');
                    taskDiv.className = `task-item ${task.completed ? 'completed' : ''}`;
                    
                    const datum = task.datum.toDate();
                    const datumStr = datum.toLocaleDateString('nl-NL', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' 
                    });

                    taskDiv.innerHTML = `
                        <div style="display: flex; align-items: center; flex-grow: 1;">
                            <input type="checkbox" 
                                   ${task.completed ? 'checked' : ''} 
                                   onchange="toggleTask('${doc.id}', this.checked)">
                            <div>
                                <strong>${task.vak}</strong> - ${task.onderwerp}
                                <div style="font-size: 0.85em; color: #666;">${datumStr}</div>
                                ${task.notities ? `<div style="font-size: 0.85em; color: #888; font-style: italic;">${task.notities}</div>` : ''}
                            </div>
                        </div>
                        <button class="delete-btn" onclick="deleteTask('${doc.id}')">√ó</button>
                    `;
                    
                    tasksList.appendChild(taskDiv);
                });
            });
        }

        // SAVE NEW TASK
        window.saveNewTask = function() {
            const vak = document.getElementById('vakInput').value.trim();
            const onderwerp = document.getElementById('onderwerpInput').value.trim();
            const datumStr = document.getElementById('datumInput').value;
            const notities = document.getElementById('notitiesInput').value.trim();
            const addToCalendar = document.getElementById('addToCalendarCheck').checked;
            const feedbackEl = document.getElementById('feedback-message');

            if (!vak || !onderwerp || !datumStr) {
                feedbackEl.style.color = '#c0392b';
                feedbackEl.innerText = "Vul alle verplichte velden in.";
                return;
            }

            const datum = new Date(datumStr);
            
            const taskData = {
                vak: vak,
                onderwerp: onderwerp,
                datum: firebase.firestore.Timestamp.fromDate(datum),
                notities: notities,
                completed: false,
                created: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('users').doc(activeUserId).collection('tasks').add(taskData)
                .then((docRef) => {
                    feedbackEl.style.color = '#27ae60';
                    feedbackEl.innerText = "Taak succesvol opgeslagen!";
                    
                    // Clear form
                    document.getElementById('vakInput').value = '';
                    document.getElementById('onderwerpInput').value = '';
                    document.getElementById('datumInput').value = '';
                    document.getElementById('notitiesInput').value = '';
                    document.getElementById('addToCalendarCheck').checked = false;

                    // Optioneel: Voeg toe aan Google Calendar
                    if (addToCalendar) {
                        addEventToGoogleCalendar(vak, onderwerp, datum, notities);
                    }

                    setTimeout(() => feedbackEl.innerText = '', 3000);
                })
                .catch(error => {
                    feedbackEl.style.color = '#c0392b';
                    feedbackEl.innerText = "Fout: " + error.message;
                });
        }

        // TOGGLE TASK COMPLETION
        window.toggleTask = function(docId, isCompleted) {
            db.collection('users').doc(activeUserId).collection('tasks').doc(docId).update({
                completed: isCompleted
            });
        }

        // DELETE TASK
        window.deleteTask = function(docId) {
            if (!confirm('Weet je zeker dat je deze taak wilt verwijderen?')) return;
            db.collection('users').doc(activeUserId).collection('tasks').doc(docId).delete();
        }

        // ADD TO GOOGLE CALENDAR (Simplified - needs proper OAuth setup)
        function addEventToGoogleCalendar(vak, onderwerp, datum, notities) {
            // Dit is een vereenvoudigde versie
            // Voor volledige functionaliteit moet je Google Calendar API juist configureren
            // met OAuth 2.0 credentials in de Google Cloud Console
            
            const event = {
                'summary': `${vak}: ${onderwerp}`,
                'description': notities,
                'start': {
                    'dateTime': datum.toISOString(),
                    'timeZone': 'Europe/Amsterdam'
                },
                'end': {
                    'dateTime': new Date(datum.getTime() + 3600000).toISOString(), // +1 hour
                    'timeZone': 'Europe/Amsterdam'
                }
            };

            // Hier zou je de Google Calendar API aanroepen
            console.log('Event to add to calendar:', event);
            alert('Calendar integratie vereist verdere configuratie. Zie console voor event data.');
        }

        // SHARING FUNCTIONS
        window.addAccessByEmail = function() {
            const emailInput = document.getElementById('docentEmailInput');
            const email = emailInput.value.trim().toLowerCase();
            const feedbackEl = document.getElementById('share-feedback');

            if (!email || !email.includes('@')) {
                feedbackEl.style.color = '#c0392b';
                feedbackEl.innerText = "Voer een geldig e-mailadres in.";
                return;
            }
            
            db.collection('users').doc(currentUserId).collection('toegang').doc(email).set({
                toegevoegd_op: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                feedbackEl.style.color = '#27ae60';
                feedbackEl.innerText = `Toegang verleend aan ${email}!`;
                emailInput.value = '';
                setTimeout(() => feedbackEl.innerText = '', 3000);
            }).catch(error => {
                feedbackEl.style.color = '#c0392b';
                feedbackEl.innerText = "Fout: " + error.message;
            });
        }
    </script>
</body>
</html>
