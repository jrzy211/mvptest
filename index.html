<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study-Start</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23007aff'/></svg>" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --off-white: #fafafa; 
            --bg-color: #f0f2f5; 
            --sidebar-bg: var(--off-white);
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-muted: #666666;
            --primary-color: #007aff; 
            --primary-hover: #005bb5;
            --border-color: #e4e6eb;
            --table-header-bg: #f8f9fa;
            --success-color: #34c759;
            --holiday-bg: #fff9e6; 
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 0px;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        #app-sidebar { 
            width: var(--sidebar-width); 
            background-color: var(--sidebar-bg); 
            border-right: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            padding: 25px; 
            flex-shrink: 0; 
            transition: margin-left 0.3s ease-in-out;
            overflow-y: auto;
        }
        
        /* Class om sidebar te verbergen */
        #app-sidebar.collapsed {
            margin-left: calc(-1 * var(--sidebar-width));
        }

        .sidebar-logo { font-size: 1.4em; font-weight: 800; color: var(--primary-color); margin-bottom: 40px; display: flex; justify-content: space-between; align-items: center;}
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: var(--text-muted); font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .nav-item:hover, .nav-item.active { background-color: rgba(0, 122, 255, 0.1); color: var(--primary-color); }

        /* --- CONTENT --- */
        #main-content { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; transition: width 0.3s; }
        
        header { 
            background-color: rgba(255,255,255,0.9); 
            backdrop-filter: blur(10px); 
            border-bottom: 1px solid var(--border-color); 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; /* Changed for toggle button */
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
        }
        
        /* Toggle Button Style */
        #sidebar-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            width: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #sidebar-toggle:hover { background-color: #eee; }

        /* LAYOUTS */
        .page-section { display: none; padding: 20px; max-width: 100%; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .page-section.active { display: flex; gap: 20px; height: 100%; }
        
        /* Planner Kolommen */
        #page-planning.active { flex-direction: row; }
        #planner-column { flex: 1; min-width: 0; display: flex; flex-direction: column; } 
        #tools-column { width: 320px; flex-shrink: 0; overflow-y: auto; padding-right: 5px; }

        /* CARDS & UI */
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        h2 { margin-top: 0; margin-bottom: 20px; font-size: 1.4em; }
        h3 { margin-top: 0; font-size: 1.1em; margin-bottom: 15px; }
        
        input, select, textarea { width: 100%; background-color: #fff; border: 1px solid #ddd; color: var(--text-color); padding: 10px; border-radius: 8px; font-family: inherit; box-sizing: border-box; margin-bottom: 10px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1); }

        button { width: 100%; background-color: var(--primary-color); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: var(--primary-hover); }
        button.secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); }
        button.secondary:hover { background-color: #f5f5f5; color: var(--text-color); }

        /* LOGIN */
        #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: flex; justify-content: center; align-items: center; background-color: var(--bg-color); }
        .login-card { background: white; padding: 40px; border-radius: 16px; text-align: center; width: 100%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }

        /* TABLE FIXES */
        .table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 12px; background: white; height: 100%; }
        .studie-tabel { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 600px; /* Kleiner minimum voor betere fit */ }
        
        .studie-tabel th { background-color: var(--table-header-bg); color: var(--text-muted); text-transform: uppercase; font-size: 0.75em; padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .studie-tabel td { padding: 12px 15px; border-bottom: 1px solid var(--border-color); vertical-align: top; }
        .studie-tabel tr:last-child td { border-bottom: none; }
        
        .col-week { width: 10%; font-weight: 700; color: var(--primary-color); }
        .col-vak { width: 12%; font-weight: 600; }
        .col-thuis { width: 45%; } /* Meer ruimte voor de taken */
        .col-bijles { width: 25%; }
        .col-status { width: 50px; text-align: center; padding: 12px 5px; } /* Compact */

        .editable-area { width: 100%; min-height: 40px; border: 1px solid transparent; padding: 5px; border-radius: 6px; resize: none; overflow: hidden; }
        .editable-area:hover { background-color: #f9f9f9; }
        .editable-area:focus { border-color: var(--primary-color); background: white; }

        .status-container { display: flex; justify-content: center; align-items: center; height: 100%; }
        .status-container input { width: 24px; height: 24px; margin: 0; cursor: pointer; accent-color: var(--success-color); }
        
        /* Vakantie */
        tr.is-holiday td { background-color: var(--holiday-bg); color: #967d00; }
        
        /* Subject Management List */
        .subject-mgmt-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .subject-mgmt-item:last-child { border-bottom: none; }
        .btn-delete-sm { background-color: #fee2e2; color: #dc2626; padding: 4px 8px; border-radius: 6px; font-size: 0.8em; width: auto; }
        .btn-delete-sm:hover { background-color: #fecaca; }

        /* Collaborators List */
        .collab-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .collab-item span { overflow: hidden; text-overflow: ellipsis; }
        .role-badge { font-size: 0.75em; padding: 2px 6px; border-radius: 4px; background: #eee; margin-left: 5px; }

        /* Timer */
        #timer-display { font-size: 4em; font-weight: 700; color: var(--primary-color); text-align: center; margin: 20px 0; }

        @media (max-width: 1000px) {
            body { flex-direction: column; height: auto; overflow-y: auto;}
            #app-sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border-color); padding: 15px; }
            #app-sidebar.collapsed { margin-left: 0; display: none; } /* Op mobiel verbergen we hem gewoon */
            #page-planning.active { flex-direction: column; }
            #tools-column { width: 100%; order: -1; }
            #sidebar-toggle { display: block; } /* Toon toggle knop */
        }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-page" style="display: none;">
        <div class="login-card">
            <h1 style="color: var(--primary-color);">Study-Start</h1>
            <p>Log in om je planner te openen.</p>
            <button onclick="signInWithGoogle()" style="background: white; color: #333; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Inloggen met Google
            </button>
        </div>
    </div>

    <!-- APP WRAPPER -->
    <div style="display: flex; width: 100%; height: 100%;">
        
        <!-- SIDEBAR -->
        <nav id="app-sidebar" style="display: none;">
            <div class="sidebar-logo">Study-Start</div>
            <div class="nav-item active" onclick="navigate('planning')">üìÖ Planning</div>
            <div class="nav-item" onclick="navigate('cijfers')">üìä Cijfers</div>
            <div class="nav-item" onclick="navigate('timer')">‚è±Ô∏è Timer</div>
            <div class="nav-item" onclick="navigate('notities')">üìù Notities</div>
            <div class="nav-item" onclick="navigate('instellingen')">‚öôÔ∏è Instellingen</div>
        </nav>

        <main id="main-content" style="display: none;">
            <header>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button id="sidebar-toggle" onclick="toggleSidebar()" title="Zijbalk in/uitklappen">
                        ‚ò∞
                    </button>
                    <div id="shared-badge" style="display: none; background: #fff3cd; color: #856404; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; border: 1px solid #ffeeba;">
                        üëÅÔ∏è Je kijkt mee
                    </div>
                    <div id="read-only-badge" style="display: none; background: #e2e3e5; color: #383d41; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; border: 1px solid #d6d8db;">
                        üîí Alleen Lezen
                    </div>
                </div>
                
                <div style="display: flex; align-items: center;">
                    <span id="user-display-name" style="font-weight: 600; margin-right: 15px;">Gast</span>
                    <button onclick="signOutUser()" class="secondary" style="width: auto; padding: 8px 15px;">Uitloggen</button>
                </div>
            </header>

            <!-- PLANNING PAGE -->
            <div id="page-planning" class="page-section active">
                <div id="planner-column">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                         <h2>Jouw Planning</h2>
                    </div>
                    <div id="loading-indicator" style="color: var(--text-muted);">Laden...</div>
                    <div class="table-container">
                        <table class="studie-tabel">
                            <thead>
                                <tr>
                                    <th class="col-week">Week</th>
                                    <th class="col-vak">Vak</th>
                                    <th class="col-thuis">Thuis Doen</th>
                                    <th class="col-bijles">Bijles</th>
                                    <th class="col-status"></th>
                                </tr>
                            </thead>
                            <tbody id="planner-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="tools-column">
                    
                    <!-- VAKKEN BEHEER (VERWIJDEREN) -->
                    <div class="card" id="manage-card">
                        <h3>üóëÔ∏è Beheer Vakken</h3>
                        <p style="font-size: 0.85em; color: var(--text-muted); margin-bottom: 10px;">Verwijder een vak (en alle geplande taken) als het verkeerd is ingepland of afgerond.</p>
                        <div id="subjects-list" style="max-height: 200px; overflow-y: auto;">
                            <!-- Dynamische lijst -->
                            <p style="color:#ccc; font-size:0.9em;">Laden...</p>
                        </div>
                    </div>

                    <!-- SHARE CARD -->
                    <div class="card" id="share-card" style="border: 1px solid var(--primary-color);">
                        <h3 style="color: var(--primary-color);">ü§ù Samenwerken</h3>
                        <p style="font-size: 0.9em; color: var(--text-muted);">Voeg het e-mailadres van je docent toe:</p>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px;">
                            <input type="email" id="collabEmail" placeholder="docent@email.com" style="margin-bottom:0;">
                            <div style="display: flex; gap: 5px;">
                                <select id="collabRole" style="margin-bottom:0; flex: 1;">
                                    <option value="read">Alleen Lezen</option>
                                    <option value="edit">Bewerken</option>
                                </select>
                                <button onclick="addCollaborator()" style="width: auto;">Toevoegen</button>
                            </div>
                        </div>
                        <div id="collaborators-list"></div>
                        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                        <p style="font-size: 0.85em; color: var(--text-muted);">Jouw Deel-Link:</p>
                        <input type="text" id="shareLinkInput" readonly style="font-size: 0.8em; color: var(--primary-color); cursor: copy; background: #f0f8ff; border-color: #b3d7ff;" onclick="this.select(); document.execCommand('copy'); alert('Link gekopieerd!');">
                    </div>

                    <!-- AUTOMATIC PLANNER -->
                    <div class="card" id="auto-planner-card">
                        <h3>‚ö° Nieuwe Toets</h3>
                        <input type="text" list="vakken-list" id="autoVakInput" placeholder="Kies een Vak">
                        <datalist id="vakken-list">
                            <option value="Wiskunde A"><option value="Wiskunde B"><option value="Natuurkunde">
                            <option value="Scheikunde"><option value="Biologie"><option value="Economie">
                            <option value="Geschiedenis"><option value="Aardrijkskunde"><option value="Nederlands">
                            <option value="Engels">
                        </datalist>
                        <select id="autoHoofdstukInput">
                            <option value="" disabled selected>Kies Hoofdstuk</option>
                            <option value="H1">H1</option><option value="H2">H2</option><option value="H3">H3</option>
                            <option value="H4">H4</option><option value="H5">H5</option><option value="H6">H6</option>
                            <option value="H7">H7</option><option value="H8">H8</option><option value="H9">H9</option>
                        </select>
                        <label style="font-size: 0.8em; color: var(--text-muted);">Toetsdatum:</label>
                        <input type="date" id="autoDatumInput">
                        <button onclick="generateAutoPlanning()">Inplannen</button>
                    </div>
                </div>
            </div>

            <!-- CIJFERS PAGE -->
            <div id="page-cijfers" class="page-section">
                <h2>Mijn Cijfers</h2>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="card" style="flex: 1; min-width: 300px;">
                        <h3>Toevoegen</h3>
                        <input type="text" id="gradeSubject" placeholder="Vak">
                        <input type="number" id="gradeValue" placeholder="Cijfer" step="0.1">
                        <input type="number" id="gradeWeight" placeholder="Weging" value="1">
                        <button onclick="addGrade()">Opslaan</button>
                    </div>
                    <div class="card" style="flex: 2; min-width: 300px;">
                        <h3>Overzicht</h3>
                        <div id="grades-list">Laden...</div>
                    </div>
                </div>
            </div>

            <!-- TIMER PAGE -->
            <div id="page-timer" class="page-section" style="align-items: center; text-align: center;">
                <h2>Focus Timer</h2>
                <div class="card" style="max-width: 400px; width: 100%;">
                    <input type="number" id="timerInput" value="25" min="1" style="text-align: center; font-size: 1.2em; width: 80px; margin: 0 auto 10px;">
                    <div id="timer-display">25:00</div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="startTimer()">Start</button>
                        <button onclick="stopTimer()" class="secondary">Stop</button>
                        <button onclick="resetTimer()" class="secondary">Reset</button>
                    </div>
                </div>
            </div>

            <!-- NOTITIES PAGE -->
            <div id="page-notities" class="page-section">
                <h2>Notities</h2>
                <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                    <textarea id="global-notes" style="flex-grow: 1; min-height: 400px; border: none; background: transparent; resize: none;" placeholder="Typ hier..." onblur="saveNotes(this.value)"></textarea>
                    <p id="notes-status" style="font-size: 0.8em; color: var(--success-color); margin-top: 5px; min-height: 1.2em;"></p>
                </div>
            </div>

            <!-- INSTELLINGEN -->
            <div id="page-instellingen" class="page-section">
                <h2>Instellingen</h2>
                <div class="card">
                    <h3>Account</h3>
                    <input type="text" id="settings-name" placeholder="Jouw naam">
                    <button onclick="saveSettings()" style="width: auto;">Opslaan</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        /* CONFIG */
        const firebaseConfig = {
          apiKey: "AIzaSyD_Kg4HjgBpG9QqpEuxfBklPL5-34G3RHI",
          authDomain: "study-start-c510c.firebaseapp.com",
          projectId: "study-start-c510c",
          storageBucket: "study-start-c510c.firebasestorage.app",
          messagingSenderId: "960911379164",
          appId: "1:960911379164:web:ad8648cfa2fe65f8620219"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUserId = null;
        let viewUserId = null;
        let userRole = 'owner'; 

        let timerInterval = null;
        let timeLeft = 25 * 60;

        /* AUTH & INIT */
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('user-display-name').innerText = user.email;
                
                const params = new URLSearchParams(window.location.search);
                const targetUid = params.get('uid');

                if (targetUid && targetUid !== currentUserId) {
                    viewUserId = targetUid;
                    checkAccess(targetUid, user.email);
                } else {
                    viewUserId = currentUserId;
                    userRole = 'owner';
                    initApp();
                }

                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-sidebar').style.display = 'flex';
                document.getElementById('main-content').style.display = 'flex';
                document.getElementById('shareLinkInput').value = `${window.location.origin}${window.location.pathname}?uid=${currentUserId}`;

            } else {
                document.getElementById('login-page').style.display = 'flex';
            }
        });

        function checkAccess(targetUid, email) {
            db.collection('users').doc(targetUid).collection('collaborators').doc(email.toLowerCase()).get()
            .then(doc => {
                if (doc.exists) {
                    userRole = doc.data().role || 'read'; 
                    initApp();
                } else {
                    alert("Geen toegang tot dit schema.");
                    window.location.href = window.location.pathname;
                }
            }).catch(() => {
                alert("Fout bij controleren toegang.");
                window.location.href = window.location.pathname;
            });
        }

        function initApp() {
            if (userRole === 'read') {
                document.getElementById('read-only-badge').style.display = 'inline-block';
                document.getElementById('share-card').style.display = 'none';
                document.getElementById('auto-planner-card').style.display = 'none'; 
                document.getElementById('manage-card').style.display = 'none'; // Verberg beheer voor lezers
            } else if (userRole === 'edit') {
                document.getElementById('shared-badge').style.display = 'inline-block';
                document.getElementById('share-card').style.display = 'none';
            } else {
                document.getElementById('share-card').style.display = 'block';
                loadCollaborators();
            }

            initPlanner();
            if(userRole === 'owner' || userRole === 'edit') {
                loadSubjectsList(); // Laad de lijst om vakken te verwijderen
            }
            
            if(userRole === 'owner') {
                loadNotes();
                loadGrades();
            }
        }

        function signInWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => alert(e.message)); }
        function signOutUser() { auth.signOut().then(() => window.location.href = window.location.pathname); }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('app-sidebar');
            sidebar.classList.toggle('collapsed');
        }

        function navigate(id) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${id}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        /* COLLABORATION LOGIC */
        function addCollaborator() {
            const email = document.getElementById('collabEmail').value.toLowerCase().trim();
            const role = document.getElementById('collabRole').value;
            if(!email) return;
            
            db.collection('users').doc(currentUserId).collection('collaborators').doc(email).set({
                role: role,
                addedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert('Toegang gegeven!');
                document.getElementById('collabEmail').value = '';
            });
        }

        function loadCollaborators() {
            db.collection('users').doc(currentUserId).collection('collaborators').onSnapshot(snap => {
                const list = document.getElementById('collaborators-list');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const div = document.createElement('div');
                    div.className = 'collab-item';
                    div.innerHTML = `
                        <div>
                            <span>${doc.id}</span>
                            <span class="role-badge">${d.role === 'edit' ? 'Bewerken' : 'Lezen'}</span>
                        </div>
                        <button onclick="removeCollab('${doc.id}')" class="secondary" style="width:auto; padding:2px 8px; font-size:0.7em;">X</button>`;
                    list.appendChild(div);
                });
            });
        }
        
        function removeCollab(email) {
            if(confirm('Toegang intrekken?')) db.collection('users').doc(currentUserId).collection('collaborators').doc(email).delete();
        }

        /* PLANNING GENERATOR */
        function generateAutoPlanning() {
            if (userRole === 'read') return alert("Alleen lezen.");
            const vak = document.getElementById('autoVakInput').value;
            const hst = document.getElementById('autoHoofdstukInput').value;
            const dateVal = document.getElementById('autoDatumInput').value;
            if(!vak || !hst || !dateVal) return alert("Vul alles in.");
            
            const toetsDate = new Date(dateVal);
            let curr = new Date(); curr.setDate(curr.getDate() - curr.getDay() + 1);
            const batch = db.batch();
            
            while(curr <= toetsDate) {
                 const end = new Date(curr); end.setDate(curr.getDate()+6);
                 const id = `${vak}-${curr.getTime()}`;
                 batch.set(db.collection('users').doc(viewUserId).collection('planner_items').doc(id), {
                     weekStart: firebase.firestore.Timestamp.fromDate(curr),
                     weekEnd: firebase.firestore.Timestamp.fromDate(end),
                     weekNummer: getWeekNumber(curr),
                     vak: vak,
                     thuisDoen: `Oefenen ${vak} ${hst}`,
                     bijlesDoen: `Vragen ${hst}`,
                     isAfgerond: false, isVakantie: false, isBijlesNodig: true,
                     groupKey: `${curr.getFullYear()}-${getWeekNumber(curr)}`
                 });
                 curr.setDate(curr.getDate()+7);
            }
            batch.commit().then(() => alert("Gepland!"));
        }

        /* PLANNER RENDER */
        function initPlanner() {
            db.collection('users').doc(viewUserId).collection('planner_items')
                .orderBy('weekStart', 'asc')
                .onSnapshot(snapshot => {
                    document.getElementById('loading-indicator').style.display = 'none';
                    const tbody = document.getElementById('planner-table-body');
                    tbody.innerHTML = '';

                    const grouped = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        data.id = doc.id;
                        data.jsDate = data.weekStart.toDate();
                        const key = data.groupKey || `${data.jsDate.getFullYear()}-${data.weekNummer}`;
                        if(!grouped[key]) grouped[key] = [];
                        grouped[key].push(data);
                    });

                    const keys = Object.keys(grouped).sort((a,b) => grouped[a][0].jsDate - grouped[b][0].jsDate);
                    
                    if(keys.length === 0) tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#999;'>Nog geen planning.</td></tr>";

                    keys.forEach(key => {
                        const items = grouped[key];
                        renderGroupedRow(tbody, items, userRole !== 'read'); 
                    });
                }, err => {
                    console.error(err);
                    if(err.code === 'permission-denied') alert("Geen toegang. Controleer of je bent toegevoegd.");
                });
        }

        /* VAKKEN BEHEER (BULK DELETE) */
        function loadSubjectsList() {
             db.collection('users').doc(viewUserId).collection('planner_items').onSnapshot(snap => {
                 const subjects = new Set();
                 snap.forEach(doc => subjects.add(doc.data().vak));
                 
                 const container = document.getElementById('subjects-list');
                 container.innerHTML = '';
                 if(subjects.size === 0) container.innerHTML = '<p style="color:#ccc; font-size:0.8em;">Geen vakken.</p>';
                 
                 subjects.forEach(vak => {
                     const div = document.createElement('div');
                     div.className = 'subject-mgmt-item';
                     div.innerHTML = `
                        <span style="font-weight:500; font-size:0.9em;">${vak}</span>
                        <button onclick="deleteSubject('${vak}')" class="btn-delete-sm">üóëÔ∏è</button>
                     `;
                     container.appendChild(div);
                 });
             });
        }
        
        function deleteSubject(vakName) {
            if(!confirm(`Weet je zeker dat je ALLE taken voor ${vakName} wilt verwijderen?`)) return;
            
            db.collection('users').doc(viewUserId).collection('planner_items')
              .where('vak', '==', vakName)
              .get()
              .then(snapshot => {
                  const batch = db.batch();
                  snapshot.docs.forEach(doc => {
                      batch.delete(doc.ref);
                  });
                  return batch.commit();
              })
              .then(() => alert(`${vakName} verwijderd.`))
              .catch(err => console.error(err));
        }

        function renderGroupedRow(container, items, isEditable) {
            const firstItem = items[0];
            const weekEndStr = firstItem.weekEnd.toDate().toLocaleDateString('nl-NL', {day: 'numeric', month: 'short'});
            const isHoliday = items.some(i => i.isVakantie);

            const row = document.createElement('tr');
            if (isHoliday) row.classList.add('is-holiday');

            let vakHtml = '', thuisHtml = '', bijlesHtml = '', statusHtml = '';

            items.forEach((item, index) => {
                const border = index < items.length - 1 ? 'border-bottom: 1px dashed var(--border-color); padding-bottom: 10px; margin-bottom: 10px;' : '';
                vakHtml += `<div style="${border} font-weight:600; padding-top:5px;">${item.vak}</div>`;
                thuisHtml += `<div style="${border}"><textarea class="editable-area" onblur="updateField('${item.id}', 'thuisDoen', this.value)" ${!isEditable || isHoliday ? 'disabled' : ''}>${isHoliday ? 'VAKANTIE!' : item.thuisDoen}</textarea></div>`;
                
                const bijlesClass = item.isBijlesNodig === false ? 'opacity:0.5; text-decoration:line-through;' : '';
                bijlesHtml += `<div style="${border}; display:flex; gap:5px; ${bijlesClass}">
                    <label class="switch" style="transform:scale(0.6);"><input type="checkbox" ${item.isBijlesNodig!==false?'checked':''} onchange="updateField('${item.id}', 'isBijlesNodig', this.checked)" ${!isEditable ? 'disabled' : ''}><span class="slider"></span></label>
                    <textarea class="editable-area" onblur="updateField('${item.id}', 'bijlesDoen', this.value)" ${!isEditable || isHoliday ? 'disabled' : ''}>${isHoliday ? '-' : item.bijlesDoen}</textarea>
                </div>`;

                statusHtml += `<div style="${border}; display:flex; justify-content:center; height:40px; align-items:center;">
                    <div class="status-container"><input type="checkbox" ${item.isAfgerond ? 'checked' : ''} onchange="updateField('${item.id}', 'isAfgerond', this.checked)" ${!isEditable ? 'disabled' : ''}></div>
                </div>`;
            });

            row.innerHTML = `
                <td class="col-week" style="border-right: 1px solid var(--border-color);">
                    WEEK ${firstItem.weekNummer}<br>
                    <span style="font-size:0.8em; color:var(--text-muted)">t/m zo ${weekEndStr}</span>
                    <div style="margin-top:5px;"><label style="font-size:0.7em;"><input type="checkbox" ${isHoliday?'checked':''} onchange="toggleHoliday('${items.map(i=>i.id).join(',')}', this.checked)" ${!isEditable ? 'disabled' : ''}> Vakantie</label></div>
                </td>
                <td class="col-vak">${vakHtml}</td>
                <td class="col-thuis">${thuisHtml}</td>
                <td class="col-bijles">${bijlesHtml}</td>
                <td class="col-status">${statusHtml}</td>
            `;
            container.appendChild(row);
        }

        function updateField(id, f, v) { if(userRole !== 'read') db.collection('users').doc(viewUserId).collection('planner_items').doc(id).update({[f]: v}); }
        function toggleHoliday(ids, val) { if(userRole !== 'read') { const b=db.batch(); ids.split(',').forEach(id=>b.update(db.collection('users').doc(viewUserId).collection('planner_items').doc(id),{isVakantie:val})); b.commit(); } }
        
        function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); }

        /* --- GRADES LOGIC --- */
        function addGrade() {
            const s = document.getElementById('gradeSubject').value;
            const g = parseFloat(document.getElementById('gradeValue').value);
            const w = parseFloat(document.getElementById('gradeWeight').value);
            if(s && g) db.collection('users').doc(currentUserId).collection('grades').add({subject:s, grade:g, weight:w, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
        }
        function loadGrades() {
            db.collection('users').doc(viewUserId).collection('grades').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const list = document.getElementById('grades-list');
                let html = '';
                const subjects = {};
                snap.forEach(doc => {
                    const d = doc.data();
                    if (!subjects[d.subject]) subjects[d.subject] = {sum:0, wSum:0, grades:[]};
                    subjects[d.subject].sum += d.grade * d.weight;
                    subjects[d.subject].wSum += d.weight;
                    subjects[d.subject].grades.push({id:doc.id, ...d});
                });
                for(const s in subjects) {
                    const avg = (subjects[s].sum / subjects[s].wSum).toFixed(1);
                    html += `<div style="margin-bottom:10px; border-bottom:1px solid #eee;"><b>${s}: ${avg}</b>`;
                    subjects[s].grades.forEach(g => html+=`<div style="font-size:0.8em; display:flex; justify-content:space-between;"><span>${g.grade} (x${g.weight})</span> <span style="cursor:pointer; color:red;" onclick="db.collection('users').doc('${currentUserId}').collection('grades').doc('${g.id}').delete()">x</span></div>`);
                    html += '</div>';
                }
                list.innerHTML = html || 'Geen cijfers';
            });
        }

        /* --- NOTES --- */
        function saveNotes(v) { db.collection('users').doc(currentUserId).collection('data').doc('notes').set({content:v}, {merge:true}).then(() => document.getElementById('notes-status').innerText='Opgeslagen!'); }
        function loadNotes() { db.collection('users').doc(viewUserId).collection('data').doc('notes').get().then(d => { if(d.exists) document.getElementById('global-notes').value = d.data().content||''; }); }

        /* --- TIMER --- */
        function updateTimerDisplay() { 
            const m = Math.floor(timeLeft/60).toString().padStart(2,'0'), s = (timeLeft%60).toString().padStart(2,'0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
        }
        function startTimer() { if(!timerInterval) timerInterval = setInterval(() => { if(timeLeft>0){timeLeft--;updateTimerDisplay()}else{stopTimer();alert("Klaar!")} }, 1000); }
        function stopTimer() { clearInterval(timerInterval); timerInterval = null; }
        function resetTimer() { stopTimer(); const val=document.getElementById('timerInput').value; timeLeft=(val?val:25)*60; updateTimerDisplay(); }
        
        function saveSettings() { const n=document.getElementById('settings-name').value; if(n) auth.currentUser.updateProfile({displayName:n}).then(()=>alert("Opgeslagen")); }
    </script>
</body>
</html>
