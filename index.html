<!-- PAGE 2: AI CHATBOT -->
<div id="page-chatbot" class="page-section">
<div style="max-width: 800px; margin: 0 auto; width: 100%;">
                <h2>ðŸ¤– AI Tutor (Powered by Gemini)</h2>
                <h2>ðŸ¤– AI Tutor</h2>
<div id="chat-container">
<div id="chat-messages">
<div class="message bot">
                            Hallo! Ik ben je AI Tutor. Stel je vraag over je huiswerk of planning. 
                            <br><small>(Zorg dat je API Key correct is ingesteld bij Instellingen)</small>
                            Hallo! Ik ben je AI Tutor. Stel je vraag!
                            <br><small>(Zorg dat je API Key is ingesteld bij Instellingen)</small>
</div>
</div>
<div class="chat-input-area">
@@ -361,7 +361,7 @@ <h3>Google Gemini API Key</h3>
event.currentTarget.classList.add('active');
}

        /* GEMINI CHATBOT (MULTI-MODEL FALLBACK) */
        /* GEMINI CHATBOT (SMART DISCOVERY) */
async function sendMessage() {
const input = document.getElementById('chatInput');
const msg = input.value.trim();
@@ -378,44 +378,50 @@ <h3>Google Gemini API Key</h3>
}
apiKey = apiKey.trim();

            // Helper functie om API te bellen
            async function callGemini(modelName) {
            // Hulpfunctie om de API te pollen
            async function tryModel(modelName) {
const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
                        contents: [{ parts: [{ text: `Je bent een bijlesdocent. Hier is de planning van de student: ${globalContext}. Vraag: ${msg}` }] }]
                        contents: [{ parts: [{ text: `Je bent een bijlesdocent. Hier is de planning: ${globalContext}. Vraag: ${msg}` }] }]
})
});
                if (!response.ok) {
                     const err = await response.json();
                     throw new Error(err.error?.message || response.statusText);
                }
                if(!response.ok) throw new Error(response.statusText);
return response.json();
}

            // Probeer modellen in volgorde van waarschijnlijkheid
try {
                // PROBEER 1: Flash (Snelst/Goedkoopst)
                try {
                    const data = await callGemini("gemini-1.5-flash");
                    botMsgDiv.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, "<br>");
                    return;
                } catch(e) { console.log("Flash failed, trying Pro..."); }

                // PROBEER 2: Pro (Stabiel)
                let data;
try {
                    const data = await callGemini("gemini-pro");
                    botMsgDiv.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, "<br>");
                    return;
                } catch(e) { console.log("Pro failed, trying 1.0..."); }
                     // Poging 1: Flash (Nieuwe standaard)
                     data = await tryModel('gemini-1.5-flash');
                } catch(e) {
                    console.log("Flash failed, trying Pro");
                    try {
                        // Poging 2: Pro (Klassiek)
                        data = await tryModel('gemini-pro');
                    } catch(e2) {
                        console.log("Pro failed, trying 1.0");
                        // Poging 3: Legacy
                        data = await tryModel('gemini-1.0-pro');
                    }
                }

                 // PROBEER 3: 1.0 Pro (Oud maar robuust)
                const data = await callGemini("gemini-1.0-pro");
                botMsgDiv.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, "<br>");
                const answer = data.candidates[0].content.parts[0].text;
                botMsgDiv.innerHTML = answer.replace(/\n/g, "<br>");

} catch (error) {
                console.error("All models failed:", error);
                botMsgDiv.innerHTML = "Fout: Kon geen verbinding maken met Gemini. Controleer je API Key.";
                // Als alles faalt, haal de lijst met beschikbare modellen op voor debugging
                try {
                    const listResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                    const listData = await listResp.json();
                    console.log("Beschikbare modellen:", listData);
                    botMsgDiv.innerHTML = "Fout: Geen geschikt model gevonden. Controleer je API key rechten. (Zie console voor details)";
                } catch(e) {
                    botMsgDiv.innerHTML = "Fout: " + error.message;
                }
}
}

@@ -430,9 +436,7 @@ <h3>Google Gemini API Key</h3>
}

function saveApiKey() {
            let key = document.getElementById('apiKeyInput').value;
            // Strip onzichtbare karakters die copy-paste fouten veroorzaken
            key = key.replace(/[^\x00-\x7F]/g, "").trim();
            const key = document.getElementById('apiKeyInput').value.trim();
if(key) { localStorage.setItem('gemini_key', key); alert("Key opgeslagen!"); }
}
