<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study-Start</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23007aff'/></svg>" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --off-white: #fafafa; 
            --bg-color: #f0f2f5; 
            --sidebar-bg: var(--off-white);
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-muted: #666666;
            --primary-color: #007aff; 
            --primary-hover: #005bb5;
            --border-color: #e4e6eb;
            --table-header-bg: #f8f9fa;
            --success-color: #34c759;
            --holiday-bg: #fff9e6; 
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        #app-sidebar { width: 260px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 25px; flex-shrink: 0; }
        .sidebar-logo { font-size: 1.4em; font-weight: 800; color: var(--primary-color); margin-bottom: 40px; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: var(--text-muted); font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .nav-item:hover, .nav-item.active { background-color: rgba(0, 122, 255, 0.1); color: var(--primary-color); }

        /* CONTENT */
        #main-content { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; }
        header { background-color: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); padding: 15px 30px; display: flex; justify-content: flex-end; align-items: center; position: sticky; top: 0; z-index: 100; }
        
        /* LAYOUTS */
        .page-section { display: none; padding: 30px; max-width: 1800px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .page-section.active { display: flex; gap: 30px; }
        #planner-column { flex: 1; min-width: 0; } /* Fix voor table overflow */
        #tools-column { width: 350px; flex-shrink: 0; }

        /* CARDS & UI */
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        h2 { margin-top: 0; margin-bottom: 20px; font-size: 1.4em; }
        h3 { margin-top: 0; font-size: 1.1em; margin-bottom: 15px; }
        
        input, select, textarea { width: 100%; background-color: #fff; border: 1px solid #ddd; color: var(--text-color); padding: 10px; border-radius: 8px; font-family: inherit; box-sizing: border-box; margin-bottom: 10px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1); }

        button { width: 100%; background-color: var(--primary-color); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: var(--primary-hover); }
        button.secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); }
        button.secondary:hover { background-color: #f5f5f5; color: var(--text-color); }

        /* LOGIN */
        #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: flex; justify-content: center; align-items: center; background-color: var(--bg-color); }
        .login-card { background: white; padding: 40px; border-radius: 16px; text-align: center; width: 100%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }

        /* TABLE FIXES */
        .table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 12px; background: white; }
        .studie-tabel { width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 800px; } /* Min-width zorgt dat hij niet plet */
        
        .studie-tabel th { background-color: var(--table-header-bg); color: var(--text-muted); text-transform: uppercase; font-size: 0.75em; padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .studie-tabel td { padding: 12px 15px; border-bottom: 1px solid var(--border-color); vertical-align: top; }
        
        /* AANGEPASTE KOLOM BREEDTES */
        .col-week { width: 10%; font-weight: 700; color: var(--primary-color); }
        .col-vak { width: 12%; font-weight: 600; }
        .col-thuis { width: 43%; } /* Meer ruimte */
        .col-bijles { width: 25%; }
        .col-status { width: 60px; text-align: center; padding-left: 5px; padding-right: 5px;} /* Heel smal */

        .editable-area { width: 100%; min-height: 40px; border: 1px solid transparent; padding: 5px; border-radius: 6px; resize: none; overflow: hidden; }
        .editable-area:hover { background-color: #f9f9f9; }
        .editable-area:focus { border-color: var(--primary-color); background: white; }

        /* Status Checkbox Only */
        .status-container { display: flex; justify-content: center; align-items: center; height: 100%; }
        .status-container input { width: 20px; height: 20px; margin: 0; cursor: pointer; }
        
        /* Vakantie */
        tr.is-holiday td { background-color: var(--holiday-bg); color: #967d00; }
        
        /* Collaborators List */
        .collab-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .collab-item span { overflow: hidden; text-overflow: ellipsis; }

        @media (max-width: 1100px) {
            body { flex-direction: column; height: auto; overflow-y: auto;}
            #app-sidebar { width: 100%; flex-direction: row; overflow-x: auto; height: auto; }
            .page-section.active { flex-direction: column; }
            #tools-column { width: 100%; order: -1; }
        }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-page" style="display: none;">
        <div class="login-card">
            <h1 style="color: var(--primary-color);">Study-Start</h1>
            <p>Log in om je planner te openen.</p>
            <button onclick="signInWithGoogle()" style="background: white; color: #333; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Inloggen met Google
            </button>
        </div>
    </div>

    <!-- APP -->
    <nav id="app-sidebar" style="display: none;">
        <div class="sidebar-logo">Study-Start</div>
        <div class="nav-item active" onclick="navigate('planning')">üìÖ Planning</div>
        <div class="nav-item" onclick="navigate('cijfers')">üìä Cijfers</div>
        <div class="nav-item" onclick="navigate('timer')">‚è±Ô∏è Timer</div>
        <div class="nav-item" onclick="navigate('instellingen')">‚öôÔ∏è Instellingen</div>
    </nav>

    <main id="main-content" style="display: none;">
        <header>
            <div id="shared-badge" style="display: none; background: #fff3cd; color: #856404; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; margin-right: 15px; border: 1px solid #ffeeba;">
                üëÅÔ∏è Je kijkt mee met iemand anders
            </div>
            <span id="user-display-name" style="font-weight: 600; margin-right: 15px;">Gast</span>
            <button onclick="signOutUser()" class="secondary" style="width: auto; padding: 8px 15px;">Uitloggen</button>
        </header>

        <!-- PLANNING PAGE -->
        <div id="page-planning" class="page-section active">
            
            <!-- Linker Kolom: Planner -->
            <div id="planner-column">
                <h2>Jouw Planning</h2>
                <div id="loading-indicator" style="color: var(--text-muted);">Laden...</div>
                
                <div class="table-container">
                    <table class="studie-tabel">
                        <thead>
                            <tr>
                                <th class="col-week">Week</th>
                                <th class="col-vak">Vak</th>
                                <th class="col-thuis">Thuis Doen</th>
                                <th class="col-bijles">Bijles</th>
                                <th class="col-status"></th>
                            </tr>
                        </thead>
                        <tbody id="planner-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Rechter Kolom: Tools -->
            <div id="tools-column">
                
                <!-- DELEN MET DOCENT (Alleen zichtbaar als je eigenaar bent) -->
                <div class="card" id="share-card" style="border: 1px solid var(--primary-color);">
                    <h3 style="color: var(--primary-color);">ü§ù Samenwerken</h3>
                    <p style="font-size: 0.9em; color: var(--text-muted);">Voeg het e-mailadres van je docent of ouder toe. Zij kunnen dan inloggen en jouw schema live bekijken en bewerken.</p>
                    
                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                        <input type="email" id="collabEmail" placeholder="docent@email.com" style="margin-bottom:0;">
                        <button onclick="addCollaborator()" style="width: auto;">Toevoegen</button>
                    </div>

                    <div id="collaborators-list">
                        <!-- Lijst met emails -->
                    </div>
                    
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                    
                    <p style="font-size: 0.85em; color: var(--text-muted);">Jouw Deel-Link (stuur dit naar de docent nadat je ze hebt toegevoegd):</p>
                    <input type="text" id="shareLinkInput" readonly style="font-size: 0.8em; color: var(--primary-color); cursor: copy; background: #f0f8ff; border-color: #b3d7ff;" onclick="this.select(); document.execCommand('copy'); alert('Link gekopieerd!');">
                </div>

                <!-- NIEUWE TAAK -->
                <div class="card">
                    <h3>+ Taak Toevoegen</h3>
                    <input type="text" id="manualVak" placeholder="Vak (bv. Wiskunde)">
                    <input type="date" id="manualDate">
                    <textarea id="manualTask" placeholder="Wat moet je doen?"></textarea>
                    <button onclick="addManualTask()">Inplannen</button>
                </div>
                
                <!-- STATISTIEKEN -->
                <div class="card">
                    <h3>Voortgang</h3>
                    <div id="progress-container">Laden...</div>
                </div>
            </div>
        </div>

        <!-- ANDERE PAGINAS (Placeholder) -->
        <div id="page-cijfers" class="page-section"><h2>Cijfers</h2><div class="card">WIP</div></div>
        <div id="page-timer" class="page-section"><h2>Timer</h2><div class="card">WIP</div></div>
        <div id="page-notities" class="page-section"><h2>Notities</h2><div class="card">WIP</div></div>
        <div id="page-instellingen" class="page-section"><h2>Instellingen</h2><div class="card">WIP</div></div>

    </main>

    <script>
        /* CONFIG */
        const firebaseConfig = {
          apiKey: "AIzaSyD_Kg4HjgBpG9QqpEuxfBklPL5-34G3RHI",
          authDomain: "study-start-c510c.firebaseapp.com",
          projectId: "study-start-c510c",
          storageBucket: "study-start-c510c.firebasestorage.app",
          messagingSenderId: "960911379164",
          appId: "1:960911379164:web:ad8648cfa2fe65f8620219"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUserId = null; // Wie is ingelogd?
        let viewUserId = null;    // Naar wie kijken we? (Kan gelijk zijn aan current)

        /* AUTH & INIT */
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('user-display-name').innerText = user.email;
                
                // Check URL voor deel-link (?uid=...)
                const params = new URLSearchParams(window.location.search);
                const targetUid = params.get('uid');

                if (targetUid && targetUid !== currentUserId) {
                    // We proberen iemand anders te bekijken.
                    // Security Rules bepalen of dit mag (email check).
                    viewUserId = targetUid;
                    document.getElementById('shared-badge').style.display = 'inline-block';
                    document.getElementById('share-card').style.display = 'none'; // Verberg deel-opties als je gast bent
                } else {
                    viewUserId = currentUserId;
                    document.getElementById('shared-badge').style.display = 'none';
                    document.getElementById('share-card').style.display = 'block';
                }

                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-sidebar').style.display = 'flex';
                document.getElementById('main-content').style.display = 'flex';

                // Zet de deel-link voor de eigenaar
                document.getElementById('shareLinkInput').value = `${window.location.origin}${window.location.pathname}?uid=${currentUserId}`;

                initPlanner();
                if (currentUserId === viewUserId) loadCollaborators();

            } else {
                document.getElementById('login-page').style.display = 'flex';
            }
        });

        function signInWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => alert(e.message)); }
        function signOutUser() { auth.signOut().then(() => window.location.href = window.location.pathname); }
        function navigate(id) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${id}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        /* COLLABORATION LOGIC */
        function addCollaborator() {
            const email = document.getElementById('collabEmail').value.toLowerCase().trim();
            if(!email) return;
            // Sla op in een subcollectie 'collaborators' onder de user. 
            // De ID van het document is het emailadres (makkelijk checken in security rules).
            db.collection('users').doc(currentUserId).collection('toegang').doc(email).set({
                addedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert('Toegang gegeven! Stuur nu de link.');
                document.getElementById('collabEmail').value = '';
            });
        }

        function loadCollaborators() {
            db.collection('users').doc(currentUserId).collection('toegang').onSnapshot(snap => {
                const list = document.getElementById('collaborators-list');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const div = document.createElement('div');
                    div.className = 'collab-item';
                    div.innerHTML = `<span>${doc.id}</span> <button onclick="removeCollab('${doc.id}')" class="secondary" style="width:auto; padding:2px 8px; font-size:0.7em;">X</button>`;
                    list.appendChild(div);
                });
            });
        }
        
        function removeCollab(email) {
            if(confirm('Toegang intrekken?')) db.collection('users').doc(currentUserId).collection('toegang').doc(email).delete();
        }

        /* PLANNER LOGIC */
        function initPlanner() {
            // Laad algemene taken
            db.collection('users').doc(viewUserId).collection('algemeen')
                .orderBy('weekKey', 'asc')
                .onSnapshot(snapshot => {
                    document.getElementById('loading-indicator').style.display = 'none';
                    const tbody = document.getElementById('planner-table-body');
                    tbody.innerHTML = '';

                    // Simpele groepering op weekKey (YYYY-WW)
                    const weeks = {};
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        d.id = doc.id;
                        if(!weeks[d.weekKey]) weeks[d.weekKey] = [];
                        weeks[d.weekKey].push(d);
                    });

                    // Sorteer weken
                    Object.keys(weeks).sort().forEach(weekKey => {
                        const tasks = weeks[weekKey];
                        // Render week row
                        const tr = document.createElement('tr');
                        
                        // Week info (parse weekKey 2025-48)
                        const [yr, wk] = weekKey.split('-');
                        
                        // Vakantie check (gebruikt eerste taak property of aparte collectie, hier versimpeld)
                        const isHoliday = tasks.some(t => t.isHoliday);

                        if(isHoliday) tr.classList.add('is-holiday');

                        // Bouw cellen
                        let vakHtml = '', thuisHtml = '', bijlesHtml = '', statusHtml = '';
                        
                        tasks.forEach((t, i) => {
                            const border = i < tasks.length-1 ? 'border-bottom:1px solid #eee; margin-bottom:5px; padding-bottom:5px;' : '';
                            vakHtml += `<div style="${border}"><b>${t.vak}</b></div>`;
                            
                            thuisHtml += `<div style="${border}"><textarea class="editable-area" onblur="updateTask('${t.id}','taak',this.value)">${t.taak || ''}</textarea></div>`;
                            
                            bijlesHtml += `<div style="${border}"><textarea class="editable-area" onblur="updateTask('${t.id}','bijles',this.value)">${t.bijles || ''}</textarea></div>`;
                            
                            statusHtml += `<div style="${border}; display:flex; justify-content:center; height:40px; align-items:center;">
                                <input type="checkbox" ${t.afgerond ? 'checked' : ''} onchange="updateTask('${t.id}','afgerond',this.checked)">
                                <button onclick="deleteTask('${t.id}')" style="background:none; border:none; color:#ccc; font-size:16px; margin-left:5px;">&times;</button>
                            </div>`;
                        });

                        tr.innerHTML = `
                            <td class="col-week">Week ${wk}<br><small>${yr}</small><br>
                            <label style="font-size:0.7em"><input type="checkbox" ${isHoliday?'checked':''} onchange="toggleHoliday('${tasks[0].id}', this.checked)"> Vakantie</label>
                            </td>
                            <td class="col-vak">${vakHtml}</td>
                            <td class="col-thuis">${thuisHtml}</td>
                            <td class="col-bijles">${bijlesHtml}</td>
                            <td class="col-status">${statusHtml}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    updateStats(snapshot.size, snapshot.docs.filter(d=>d.data().afgerond).length);
                }, err => {
                    console.error(err);
                    if(err.code === 'permission-denied') alert("Geen toegang! Vraag de eigenaar om je e-mail toe te voegen.");
                });
        }

        function addManualTask() {
            const vak = document.getElementById('manualVak').value;
            const date = document.getElementById('manualDate').value;
            const taak = document.getElementById('manualTask').value;
            
            if(!vak || !date) return alert("Vul vak en datum in");
            
            // Bereken weekKey
            const d = new Date(date);
            const onejan = new Date(d.getFullYear(), 0, 1);
            const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            const weekKey = `${d.getFullYear()}-${week}`;

            db.collection('users').doc(viewUserId).collection('algemeen').add({
                vak, taak, weekKey, afgerond: false, bijles: '', date: date,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('manualTask').value = '';
                alert("Ingepland!");
            });
        }

        function updateTask(id, field, val) {
            db.collection('users').doc(viewUserId).collection('algemeen').doc(id).update({ [field]: val });
        }
        function deleteTask(id) {
            if(confirm("Verwijderen?")) db.collection('users').doc(viewUserId).collection('algemeen').doc(id).delete();
        }
        // Simpele vakantie toggle: update de EERSTE taak van die week (voor nu)
        function toggleHoliday(id, val) {
             db.collection('users').doc(viewUserId).collection('algemeen').doc(id).update({ isHoliday: val });
        }

        function updateStats(total, done) {
            const p = total === 0 ? 0 : Math.round((done/total)*100);
            document.getElementById('progress-container').innerHTML = `
                <div style="font-size:2em; font-weight:bold; color:var(--primary-color); text-align:center;">${p}%</div>
                <div style="background:#eee; height:10px; border-radius:5px; overflow:hidden; margin-top:5px;">
                    <div style="width:${p}%; background:var(--primary-color); height:100%;"></div>
                </div>
                <div style="text-align:center; font-size:0.8em; color:#666; margin-top:5px;">${done} van ${total} taken afgerond</div>
            `;
        }
    </script>
</body>
</html>
